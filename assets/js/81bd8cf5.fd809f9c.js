"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[6993],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>m});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var d=a.createContext({}),u=function(e){var n=a.useContext(d),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},p=function(e){var n=u(e.components);return a.createElement(d.Provider,{value:n},e.children)},s={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},c=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,l=e.originalType,d=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),c=u(t),m=r,f=c["".concat(d,".").concat(m)]||c[m]||s[m]||l;return t?a.createElement(f,i(i({ref:n},p),{},{components:t})):a.createElement(f,i({ref:n},p))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var l=t.length,i=new Array(l);i[0]=c;var o={};for(var d in n)hasOwnProperty.call(n,d)&&(o[d]=n[d]);o.originalType=e,o.mdxType="string"==typeof e?e:r,i[1]=o;for(var u=2;u<l;u++)i[u]=t[u];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}c.displayName="MDXCreateElement"},5162:(e,n,t)=>{t.d(n,{Z:()=>i});var a=t(7294),r=t(6010);const l="tabItem_Ymn6";function i(e){var n=e.children,t=e.hidden,i=e.className;return a.createElement("div",{role:"tabpanel",className:(0,r.Z)(l,i),hidden:t},n)}},5488:(e,n,t)=>{t.d(n,{Z:()=>m});var a=t(7462),r=t(7294),l=t(6010),i=t(2389),o=t(7392),d=t(7094),u=t(2466);const p="tabList__CuJ",s="tabItem_LNqP";function c(e){var n,t,i=e.lazy,c=e.block,m=e.defaultValue,f=e.values,v=e.groupId,g=e.className,h=r.Children.map(e.children,(function(e){if((0,r.isValidElement)(e)&&"value"in e.props)return e;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')})),k=null!=f?f:h.map((function(e){var n=e.props;return{value:n.value,label:n.label,attributes:n.attributes}})),b=(0,o.l)(k,(function(e,n){return e.value===n.value}));if(b.length>0)throw new Error('Docusaurus error: Duplicate values "'+b.map((function(e){return e.value})).join(", ")+'" found in <Tabs>. Every value needs to be unique.');var N=null===m?m:null!=(n=null!=m?m:null==(t=h.find((function(e){return e.props.default})))?void 0:t.props.value)?n:h[0].props.value;if(null!==N&&!k.some((function(e){return e.value===N})))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+N+'" but none of its children has the corresponding value. Available values are: '+k.map((function(e){return e.value})).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");var E=(0,d.U)(),y=E.tabGroupChoices,_=E.setTabGroupChoices,w=(0,r.useState)(N),R=w[0],A=w[1],C=[],T=(0,u.o5)().blockElementScrollPositionUntilNextRender;if(null!=v){var P=y[v];null!=P&&P!==R&&k.some((function(e){return e.value===P}))&&A(P)}var O=function(e){var n=e.currentTarget,t=C.indexOf(n),a=k[t].value;a!==R&&(T(n),A(a),null!=v&&_(v,String(a)))},I=function(e){var n,t=null;switch(e.key){case"ArrowRight":var a,r=C.indexOf(e.currentTarget)+1;t=null!=(a=C[r])?a:C[0];break;case"ArrowLeft":var l,i=C.indexOf(e.currentTarget)-1;t=null!=(l=C[i])?l:C[C.length-1]}null==(n=t)||n.focus()};return r.createElement("div",{className:(0,l.Z)("tabs-container",p)},r.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,l.Z)("tabs",{"tabs--block":c},g)},k.map((function(e){var n=e.value,t=e.label,i=e.attributes;return r.createElement("li",(0,a.Z)({role:"tab",tabIndex:R===n?0:-1,"aria-selected":R===n,key:n,ref:function(e){return C.push(e)},onKeyDown:I,onFocus:O,onClick:O},i,{className:(0,l.Z)("tabs__item",s,null==i?void 0:i.className,{"tabs__item--active":R===n})}),null!=t?t:n)}))),i?(0,r.cloneElement)(h.filter((function(e){return e.props.value===R}))[0],{className:"margin-top--md"}):r.createElement("div",{className:"margin-top--md"},h.map((function(e,n){return(0,r.cloneElement)(e,{key:n,hidden:e.props.value!==R})}))))}function m(e){var n=(0,i.Z)();return r.createElement(c,(0,a.Z)({key:String(n)},e))}},7042:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>p,default:()=>v,frontMatter:()=>u,metadata:()=>s,toc:()=>m});var a=t(7462),r=t(3366),l=(t(7294),t(3905)),i=t(5488),o=t(5162),d=["components"],u={id:"client-side-rendering",title:"Client-side rendering"},p=void 0,s={unversionedId:"guides/client-side-rendering",id:"guides/client-side-rendering",title:"Client-side rendering",description:"Introduction",source:"@site/tmp-docs/guides/client-side-rendering.md",sourceDirName:"guides",slug:"/guides/client-side-rendering",permalink:"/docs/guides/client-side-rendering",draft:!1,editUrl:"https://github.com/Tinkoff/tramvai/-/edit/master/docs/get-started/overview.md/tmp-docs/guides/client-side-rendering.md",tags:[],version:"current",frontMatter:{id:"client-side-rendering",title:"Client-side rendering"},sidebar:"sidebar",previous:{title:"Bundle optimization",permalink:"/docs/guides/bundle-optimization"},next:{title:"CPU profiling",permalink:"/docs/guides/cpu-profiling"}},c={},m=[{value:"Introduction",id:"introduction",level:2},{value:"Get started",id:"get-started",level:2},{value:"Deep dive",id:"deep-dive",level:2},{value:"Environment variables",id:"environment-variables",level:3},{value:"Testing",id:"testing",level:3},{value:"Known errors",id:"known-errors",level:3},{value:"Infinite reload",id:"infinite-reload",level:4}],f={toc:m};function v(e){var n=e.components,t=(0,r.Z)(e,d);return(0,l.kt)("wrapper",(0,a.Z)({},f,t,{components:n,mdxType:"MDXLayout"}),(0,l.kt)("h2",{id:"introduction"},"Introduction"),(0,l.kt)("p",null,"Tramvai doesn't have full client-side rendering mode, but has limited ability to render page content only in browser.\nIn this mode, all requests to application server will be handled as usual, but instead of real pages content rendering, we can render only light-weight fallback (spinner, skeleton, etc.) on server.\nAfter page loading in browser, full page will be rendered.\nIt is very useful to reduce the load on the application server."),(0,l.kt)("h2",{id:"get-started"},"Get started"),(0,l.kt)("admonition",{type:"caution"},(0,l.kt)("p",{parentName:"admonition"},"Before using a feature, make sure you use ",(0,l.kt)("inlineCode",{parentName:"p"},"SpaRouterModule"),"!\nWith ",(0,l.kt)("inlineCode",{parentName:"p"},"NoSpaRouterModule")," you will have a cyclic redirect.")),(0,l.kt)("p",null,"\u231b Install ",(0,l.kt)("inlineCode",{parentName:"p"},"@tramvai/module-page-render-mode")," module:"),(0,l.kt)(i.Z,{groupId:"npm2yarn",mdxType:"Tabs"},(0,l.kt)(o.Z,{value:"npm",mdxType:"TabItem"},(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"npm install @tramvai/module-page-render-mode\n"))),(0,l.kt)(o.Z,{value:"yarn",label:"Yarn",mdxType:"TabItem"},(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"yarn add @tramvai/module-page-render-mode\n")))),(0,l.kt)("p",null,"\u231b \u0421onnect module in the project:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-tsx"},"import { createApp } from '@tramvai/core';\nimport { PageRenderModeModule } from '@tramvai/module-page-render-mode';\n\ncreateApp({\n  name: 'tincoin',\n  modules: [ PageRenderModeModule ],\n});\n")),(0,l.kt)("p",null,(0,l.kt)("a",{parentName:"p",href:"/docs/references/modules/page-render-mode"},"@tramvai/module-page-render-mode documentation")),(0,l.kt)("p",null,"After that, we need to provide default fallback.\nIn this guide, it fill be empty white page."),(0,l.kt)("p",null,"\u231b Provide fallback page:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-tsx"},"import React from 'react';\nimport { createApp } from '@tramvai/core';\nimport {\n  PageRenderModeModule,\n  // highlight-next-line\n  PAGE_RENDER_DEFAULT_FALLBACK_COMPONENT,\n} from '@tramvai/module-page-render-mode';\n\n// highlight-next-line\nconst Fallback = () => null;\n\ncreateApp({\n  name: 'tincoin',\n  modules: [ PageRenderModeModule ],\n  providers: [\n    // highlight-start\n    {\n      provide: PAGE_RENDER_DEFAULT_FALLBACK_COMPONENT,\n      useValue: Fallback,\n    },\n    // highlight-end\n  ],\n});\n")),(0,l.kt)("p",null,"\u231b Prevent Header and Footer rendering:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-tsx"},"import React from 'react';\nimport { createApp } from '@tramvai/core';\nimport {\n  PageRenderModeModule,\n  PAGE_RENDER_DEFAULT_FALLBACK_COMPONENT,\n  // highlight-next-line\n  PAGE_RENDER_WRAPPER_TYPE,\n} from '@tramvai/module-page-render-mode';\n\nconst Fallback = () => null;\n\ncreateApp({\n  name: 'tincoin',\n  modules: [ PageRenderModeModule ],\n  providers: [\n    {\n      provide: PAGE_RENDER_DEFAULT_FALLBACK_COMPONENT,\n      useValue: Fallback,\n    },\n    // highlight-start\n    {\n      provide: PAGE_RENDER_WRAPPER_TYPE,\n      useValue: 'layout',\n    },\n    // highlight-end\n  ],\n});\n")),(0,l.kt)("p",null,"After that, you can run ",(0,l.kt)("inlineCode",{parentName:"p"},"client")," rendering mode for concrete pages, or for all of it.\nIn this guide, we will enable ",(0,l.kt)("inlineCode",{parentName:"p"},"client")," mode for all pages."),(0,l.kt)("p",null,"\u231b Enable ",(0,l.kt)("inlineCode",{parentName:"p"},"client")," mode:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-tsx"},"import React from 'react';\nimport { createApp } from '@tramvai/core';\n  // highlight-next-line\nimport { TRAMVAI_RENDER_MODE } from '@tramvai/tokens-render';\nimport {\n  PageRenderModeModule,\n  PAGE_RENDER_DEFAULT_FALLBACK_COMPONENT,\n  PAGE_RENDER_WRAPPER_TYPE,\n} from '@tramvai/module-page-render-mode';\n\nconst Fallback = () => null;\n\ncreateApp({\n  name: 'tincoin',\n  modules: [ PageRenderModeModule ],\n  providers: [\n    {\n      provide: PAGE_RENDER_DEFAULT_FALLBACK_COMPONENT,\n      useValue: Fallback,\n    },\n    {\n      provide: PAGE_RENDER_WRAPPER_TYPE,\n      useValue: 'layout',\n    },\n    // highlight-start\n    {\n      provide: TRAMVAI_RENDER_MODE,\n      useValue: 'client',\n    },\n    // highlight-end\n  ],\n});\n")),(0,l.kt)("p",null,"After that, all requests to application will return white page, and original content will be rendered after main scripts will be loaded, parsed and executed."),(0,l.kt)("h2",{id:"deep-dive"},"Deep dive"),(0,l.kt)("p",null,"For achieve maximum server performance, we can cache our page fallback, and distribute it from the cdn or balancer.\nThis will completely free up the application server."),(0,l.kt)("admonition",{type:"caution"},(0,l.kt)("p",{parentName:"admonition"},"When caching a fallback, your users potentially can have a outdated content.\nAlso, you will have the same meta tags for all application pages, it can affect SEO."),(0,l.kt)("p",{parentName:"admonition"},"Some important features will not work:"),(0,l.kt)("ul",{parentName:"admonition"},(0,l.kt)("li",{parentName:"ul"},"User-Agent parsing - User-Agent or Client-Hints parsed only at server side, so you will need to realize it on client side if you need it"),(0,l.kt)("li",{parentName:"ul"},"Media detection - always will came wrong from server (with SSR only first load will be without real data), so will be useless for optimizations"))),(0,l.kt)("p",null,"For one client-side rendering fallback, which will work on every application route, we need a few things:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Fallback component with some preloader or skeleton (",(0,l.kt)("inlineCode",{parentName:"li"},"PAGE_RENDER_DEFAULT_FALLBACK_COMPONENT"),")"),(0,l.kt)("li",{parentName:"ul"},"Special route for this page (for example, ",(0,l.kt)("inlineCode",{parentName:"li"},"/__csr_fallback__/"),")"),(0,l.kt)("li",{parentName:"ul"},"Build application (server and client code) as usual"),(0,l.kt)("li",{parentName:"ul"},"Generate static HTML page for ",(0,l.kt)("inlineCode",{parentName:"li"},"/__csr_fallback__/")," route")),(0,l.kt)("p",null,"All of this are included when using ",(0,l.kt)("inlineCode",{parentName:"p"},"tramvai static")," command with ",(0,l.kt)("inlineCode",{parentName:"p"},"TRAMVAI_FORCE_CLIENT_SIDE_RENDERING=true")," env variable, when ",(0,l.kt)("inlineCode",{parentName:"p"},"@tramvai/module-page-render-mode")," are connected in the application. Only one step you need for HTML fallback generation:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"TRAMVAI_FORCE_CLIENT_SIDE_RENDERING=true tramvai static {{ appName }}\n")),(0,l.kt)("admonition",{type:"tip"},(0,l.kt)("p",{parentName:"admonition"},"How ",(0,l.kt)("inlineCode",{parentName:"p"},"tramvai static")," works?"),(0,l.kt)("p",{parentName:"admonition"},"This command basically runs the compiled ",(0,l.kt)("inlineCode",{parentName:"p"},"server.js")," and makes a HTTP request to the specified URLs, every response will be saved as an HTML file.")),(0,l.kt)("p",null,"After this steps, you can find a file ",(0,l.kt)("inlineCode",{parentName:"p"},"dist/static/__csr_fallback__/index.html"),".\nYou can deploy this file with other assets to S3 file storage and serve this file from CDN or balancer, and it will be working as usual SPA."),(0,l.kt)("h3",{id:"environment-variables"},"Environment variables"),(0,l.kt)("p",null,"In ",(0,l.kt)("inlineCode",{parentName:"p"},"tramvai")," application we can separate a two types of env variables:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"build-time env"),(0,l.kt)("li",{parentName:"ul"},"deployment env")),(0,l.kt)("p",null,"When using the command ",(0,l.kt)("inlineCode",{parentName:"p"},"TRAMVAI_FORCE_CLIENT_SIDE_RENDERING=true tramvai static {{ appName }}"),", you need to pass both build-time and deployment env for CI job when you will run ",(0,l.kt)("inlineCode",{parentName:"p"},"tramvai static"),", because of real application server will be launched for this command, and real requests for API's will be sended."),(0,l.kt)("p",null,"Env variable ",(0,l.kt)("inlineCode",{parentName:"p"},"TRAMVAI_FORCE_CLIENT_SIDE_RENDERING")," will be available in ",(0,l.kt)("inlineCode",{parentName:"p"},"ENV_MANAGER_TOKEN"),", you can use it for some custom logic about CSR."),(0,l.kt)("h3",{id:"testing"},"Testing"),(0,l.kt)("p",null,"For fallback development, you can use start command with CSR flag - ",(0,l.kt)("inlineCode",{parentName:"p"},"TRAMVAI_FORCE_CLIENT_SIDE_RENDERING=true tramvai start {{ appName }}")," - and open special route ",(0,l.kt)("inlineCode",{parentName:"p"},"http://localhost:3000/__csr_fallback__/")," in browser."),(0,l.kt)("p",null,"For testing fallback close to production, you can use ",(0,l.kt)("inlineCode",{parentName:"p"},"http-server")," library, and this scripts:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"TRAMVAI_FORCE_CLIENT_SIDE_RENDERING=true ASSETS_PREFIX=http://localhost:4444/ tramvai static {{ appName }}")," for build and fallback generation"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"npx http-server dist/static/__csr_fallback__ --proxy http://localhost:8080\\\\? --cors")," for serving fallback HTML at 8080 port"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"npx http-server dist/client -p 4444 --cors")," for serving assets at 4444 port")),(0,l.kt)("h3",{id:"known-errors"},"Known errors"),(0,l.kt)("h4",{id:"infinite-reload"},"Infinite reload"),(0,l.kt)("p",null,"It is expected error, when you try to open fallback page in browser locally or directly from ",(0,l.kt)("inlineCode",{parentName:"p"},"s3"),", and it will be reloaded infinitely."),(0,l.kt)("p",null,"When you open a fallback page, it will try to navigate to the current url, and if current url is not registered in app router, not found logic will be triggered, which will force hard reload under the hood."),(0,l.kt)("p",null,"If you want to test fallback locally - use ",(0,l.kt)("inlineCode",{parentName:"p"},"http-server")," as described above in ",(0,l.kt)("a",{parentName:"p",href:"#testing"},"Testing")," section. For production environment, you need to configure your own balancer to serve fallback page for all routes."))}v.isMDXComponent=!0}}]);