"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[9841],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>m});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),u=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=u(e.components);return r.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},c=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),c=u(n),m=a,h=c["".concat(s,".").concat(m)]||c[m]||p[m]||i;return n?r.createElement(h,o(o({ref:t},d),{},{components:n})):r.createElement(h,o({ref:t},d))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var u=2;u<i;u++)o[u]=n[u];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}c.displayName="MDXCreateElement"},5162:(e,t,n)=>{n.d(t,{Z:()=>o});var r=n(7294),a=n(6010);const i="tabItem_Ymn6";function o(e){var t=e.children,n=e.hidden,o=e.className;return r.createElement("div",{role:"tabpanel",className:(0,a.Z)(i,o),hidden:n},t)}},4866:(e,t,n)=>{n.d(t,{Z:()=>N});var r=n(7462),a=n(7294),i=n(6010),o=n(2466),l=n(6550),s=n(1980),u=n(7392),d=n(12);function p(e){return function(e){return a.Children.map(e,(function(e){if((0,a.isValidElement)(e)&&"value"in e.props)return e;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')}))}(e).map((function(e){var t=e.props;return{value:t.value,label:t.label,attributes:t.attributes,default:t.default}}))}function c(e){var t=e.values,n=e.children;return(0,a.useMemo)((function(){var e=null!=t?t:p(n);return function(e){var t=(0,u.l)(e,(function(e,t){return e.value===t.value}));if(t.length>0)throw new Error('Docusaurus error: Duplicate values "'+t.map((function(e){return e.value})).join(", ")+'" found in <Tabs>. Every value needs to be unique.')}(e),e}),[t,n])}function m(e){var t=e.value;return e.tabValues.some((function(e){return e.value===t}))}function h(e){var t=e.queryString,n=void 0!==t&&t,r=e.groupId,i=(0,l.k6)(),o=function(e){var t=e.queryString,n=void 0!==t&&t,r=e.groupId;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!r)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return null!=r?r:null}({queryString:n,groupId:r});return[(0,s._X)(o),(0,a.useCallback)((function(e){if(o){var t=new URLSearchParams(i.location.search);t.set(o,e),i.replace(Object.assign({},i.location,{search:t.toString()}))}}),[o,i])]}function f(e){var t,n,r,i,o=e.defaultValue,l=e.queryString,s=void 0!==l&&l,u=e.groupId,p=c(e),f=(0,a.useState)((function(){return function(e){var t,n=e.defaultValue,r=e.tabValues;if(0===r.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!m({value:n,tabValues:r}))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+n+'" but none of its children has the corresponding value. Available values are: '+r.map((function(e){return e.value})).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");return n}var a=null!=(t=r.find((function(e){return e.default})))?t:r[0];if(!a)throw new Error("Unexpected error: 0 tabValues");return a.value}({defaultValue:o,tabValues:p})})),v=f[0],k=f[1],g=h({queryString:s,groupId:u}),b=g[0],y=g[1],w=(t=function(e){return e?"docusaurus.tab."+e:null}({groupId:u}.groupId),n=(0,d.Nk)(t),r=n[0],i=n[1],[r,(0,a.useCallback)((function(e){t&&i.set(e)}),[t,i])]),N=w[0],C=w[1],x=function(){var e=null!=b?b:N;return m({value:e,tabValues:p})?e:null}();return(0,a.useLayoutEffect)((function(){x&&k(x)}),[x]),{selectedValue:v,selectValue:(0,a.useCallback)((function(e){if(!m({value:e,tabValues:p}))throw new Error("Can't select invalid tab value="+e);k(e),y(e),C(e)}),[y,C,p]),tabValues:p}}var v=n(2389);const k="tabList__CuJ",g="tabItem_LNqP";function b(e){var t=e.className,n=e.block,l=e.selectedValue,s=e.selectValue,u=e.tabValues,d=[],p=(0,o.o5)().blockElementScrollPositionUntilNextRender,c=function(e){var t=e.currentTarget,n=d.indexOf(t),r=u[n].value;r!==l&&(p(t),s(r))},m=function(e){var t,n=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":var r,a=d.indexOf(e.currentTarget)+1;n=null!=(r=d[a])?r:d[0];break;case"ArrowLeft":var i,o=d.indexOf(e.currentTarget)-1;n=null!=(i=d[o])?i:d[d.length-1]}null==(t=n)||t.focus()};return a.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.Z)("tabs",{"tabs--block":n},t)},u.map((function(e){var t=e.value,n=e.label,o=e.attributes;return a.createElement("li",(0,r.Z)({role:"tab",tabIndex:l===t?0:-1,"aria-selected":l===t,key:t,ref:function(e){return d.push(e)},onKeyDown:m,onClick:c},o,{className:(0,i.Z)("tabs__item",g,null==o?void 0:o.className,{"tabs__item--active":l===t})}),null!=n?n:t)})))}function y(e){var t=e.lazy,n=e.children,r=e.selectedValue;if(n=Array.isArray(n)?n:[n],t){var i=n.find((function(e){return e.props.value===r}));return i?(0,a.cloneElement)(i,{className:"margin-top--md"}):null}return a.createElement("div",{className:"margin-top--md"},n.map((function(e,t){return(0,a.cloneElement)(e,{key:t,hidden:e.props.value!==r})})))}function w(e){var t=f(e);return a.createElement("div",{className:(0,i.Z)("tabs-container",k)},a.createElement(b,(0,r.Z)({},e,t)),a.createElement(y,(0,r.Z)({},e,t)))}function N(e){var t=(0,v.Z)();return a.createElement(w,(0,r.Z)({key:String(t)},e))}},1566:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>d,default:()=>f,frontMatter:()=>u,metadata:()=>p,toc:()=>m});var r=n(7462),a=n(3366),i=(n(7294),n(3905)),o=n(4866),l=n(5162),s=["components"],u={},d=void 0,p={unversionedId:"references/modules/client-hints",id:"references/modules/client-hints",title:"client-hints",description:"Modules provides various parameters from the client device, e.g. type of the device, screen size, etc.",source:"@site/tmp-docs/references/modules/client-hints.md",sourceDirName:"references/modules",slug:"/references/modules/client-hints",permalink:"/docs/references/modules/client-hints",draft:!1,editUrl:"https://github.com/Tinkoff/tramvai/-/edit/master/docs/get-started/overview.md/tmp-docs/references/modules/client-hints.md",tags:[],version:"current",frontMatter:{},sidebar:"sidebar",previous:{title:"child-app",permalink:"/docs/references/modules/child-app"},next:{title:"common",permalink:"/docs/references/modules/common"}},c={},m=[{value:"Installation",id:"installation",level:2},{value:"Explanation",id:"explanation",level:2},{value:"User agent details parsing",id:"user-agent-details-parsing",level:3},{value:"The problem with media on server and on client",id:"the-problem-with-media-on-server-and-on-client",level:3},{value:"How does media work",id:"how-does-media-work",level:3},{value:"First page loading",id:"first-page-loading",level:4},{value:"Next page loads",id:"next-page-loads",level:4},{value:"Use ClientHints in component",id:"use-clienthints-in-component",level:4},{value:"Api",id:"api",level:2},{value:"Stores",id:"stores",level:3},{value:"userAgent",id:"useragent",level:4},{value:"media",id:"media",level:4},{value:"media helpers",id:"media-helpers",level:3},{value:"How to",id:"how-to",level:2},{value:"Render skeleton only when user loads pages first time",id:"render-skeleton-only-when-user-loads-pages-first-time",level:3},{value:"Render adaptive component on first time and on subsequent loads render specific component",id:"render-adaptive-component-on-first-time-and-on-subsequent-loads-render-specific-component",level:3},{value:"Exported tokens",id:"exported-tokens",level:2},{value:"USER_AGENT_TOKEN",id:"user_agent_token",level:3}],h={toc:m};function f(e){var t=e.components,n=(0,a.Z)(e,s);return(0,i.kt)("wrapper",(0,r.Z)({},h,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"Modules provides various parameters from the client device, e.g. type of the device, screen size, etc."),(0,i.kt)("h2",{id:"installation"},"Installation"),(0,i.kt)("p",null,"First, install ",(0,i.kt)("inlineCode",{parentName:"p"},"@tramvai/module-client-hints")),(0,i.kt)(o.Z,{groupId:"npm2yarn",mdxType:"Tabs"},(0,i.kt)(l.Z,{value:"npm",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"npm i --save @tramvai/module-client-hints\n"))),(0,i.kt)(l.Z,{value:"yarn",label:"Yarn",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"yarn i --save @tramvai/module-client-hints\n# couldn't auto-convert command\n")))),(0,i.kt)("p",null,"Then add ",(0,i.kt)("inlineCode",{parentName:"p"},"ClientHintsModule")," to the modules list"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx"},"import { createApp } from '@tramvai/core';\nimport { ClientHintsModule } from '@tramvai/module-client-hints';\n\ncreateApp({\n  modules: [ClientHintsModule],\n});\n")),(0,i.kt)("h2",{id:"explanation"},"Explanation"),(0,i.kt)("h3",{id:"user-agent-details-parsing"},"User agent details parsing"),(0,i.kt)("p",null,"Parsing is implemented with library ",(0,i.kt)("a",{parentName:"p",href:"/docs/references/libs/user-agent"},"@tinkoff/user-agent")," that may use either user-agent header or client-hints headers."),(0,i.kt)("p",null,"If there is a ",(0,i.kt)("inlineCode",{parentName:"p"},"sec-ch-ua")," header in request than user agent parsing will be based on ",(0,i.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Client_hints"},"Client Hints")," headers. If there is no such header than old school parsing of user-agent string will be used."),(0,i.kt)("p",null,"This logic implies next things worth to mention:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"by default, only part of client-hints is sent by browser and you can get only partial info about user browser (no cpu spec, platform version or device model). Although, we send an additional header ",(0,i.kt)("inlineCode",{parentName:"li"},"accept-ch")," with response from server to request this data from client - on first request from current browser there will be no such data in any case and they will appear only on subsequent requests"),(0,i.kt)("li",{parentName:"ul"},"if you need to use additional info, you may specify the header ",(0,i.kt)("a",{parentName:"li",href:"https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Accept-CH"},(0,i.kt)("inlineCode",{parentName:"a"},"accept-ch"))," in your app with ",(0,i.kt)("inlineCode",{parentName:"li"},"REQUEST_MANAGER_TOKEN")),(0,i.kt)("li",{parentName:"ul"},"client-hints is mostly more performant way to parse browser info and this is way it used if it's possible"),(0,i.kt)("li",{parentName:"ul"},"currently only chromium based browsers support client hints, so for other browsers and bots user-agent header will be used to gather browser info")),(0,i.kt)("h3",{id:"the-problem-with-media-on-server-and-on-client"},"The problem with media on server and on client"),(0,i.kt)("p",null,"One of the SSR problem is render of the component which depends of current screen size, e.g. image carousel that should render specific number of images depending of screen width. By default, the exact screen size can be figured out only on client-side and we can't render such content on server identical to the client render. If this content is not important for the SEO we can use skeletons and spinners, but they are not suitable for every case."),(0,i.kt)("p",null,"Client Hints modules provides the way to solve this problem in some way. It stores data about client devices in cookies and then use this cookies on server in next page loading."),(0,i.kt)("h3",{id:"how-does-media-work"},"How does media work"),(0,i.kt)("h4",{id:"first-page-loading"},"First page loading"),(0,i.kt)("admonition",{type:"warning"},(0,i.kt)("p",{parentName:"admonition"},"When user enters the app for the first time, information about ",(0,i.kt)("strong",{parentName:"p"},"real")," device screen size and type ",(0,i.kt)("strong",{parentName:"p"},"not available")," in server-side code.")),(0,i.kt)("p",null,"This module tries to determine type of the user device using user-agent string, and separates the devices into three groups:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"mobile")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"tablet")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"desktop"))),(0,i.kt)("p",null,"Then it saves this ",(0,i.kt)("strong",{parentName:"p"},"assumptive")," information about device screen to ",(0,i.kt)("inlineCode",{parentName:"p"},"media")," store. E.g. when user loads page from the desktop, then content of the ",(0,i.kt)("inlineCode",{parentName:"p"},"media")," store will be following:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx"},"const state = {\n  // desktop - 1024px, tablet - 600px, mobile - 300px\n  width: 1024,\n  // desktop - 768px, tablet - 800px, mobile - 500px\n  height: 768,\n  // desktop - false, tablet - true, mobile - true\n  isTouch: false,\n  retina: false,\n  supposed: true,\n  synchronized: false,\n};\n")),(0,i.kt)("p",null,"On the client focusing on value ",(0,i.kt)("inlineCode",{parentName:"p"},"supposed: true")," module resolves ",(0,i.kt)("strong",{parentName:"p"},"real")," info about client device, updates ",(0,i.kt)("inlineCode",{parentName:"p"},"media")," store and calls the rerender for the dependent components. E.g. for the widescreen monitor the data of ",(0,i.kt)("inlineCode",{parentName:"p"},"media")," store might be next:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx"},"const state = {\n  width: 1920,\n  height: 1080,\n  isTouch: false,\n  retina: true,\n  supposed: false,\n  synchronized: false,\n};\n")),(0,i.kt)("p",null,"While we have value ",(0,i.kt)("inlineCode",{parentName:"p"},"synchronized: false")," ",(0,i.kt)("strong",{parentName:"p"},"it is not allowed")," to use data from the ",(0,i.kt)("inlineCode",{parentName:"p"},"media")," store for on the server-side as data is not synchronized with the client and it will lead to page jumps when saving real data about device."),(0,i.kt)("h4",{id:"next-page-loads"},"Next page loads"),(0,i.kt)("p",null,"When user loads the app next time the data about user device will be read from cookies and value ",(0,i.kt)("inlineCode",{parentName:"p"},"synchronized")," will be set to true. This way on server and on client we will get the same content of the ",(0,i.kt)("inlineCode",{parentName:"p"},"media")," store and no page rerenders on the client:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx"},"const state = {\n  width: 1920,\n  height: 1080,\n  isTouch: false,\n  retina: true,\n  supposed: false,\n  synchronized: true,\n};\n")),(0,i.kt)("h4",{id:"use-clienthints-in-component"},"Use ClientHints in component"),(0,i.kt)("p",null,"If some component if depend of screen size:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"When user loads app for the first time ",(0,i.kt)("strong",{parentName:"li"},"is not possible")," to guarantee the same exact render on server and client"),(0,i.kt)("li",{parentName:"ol"},"On first app load you may show some skeleton to the user by checking ",(0,i.kt)("inlineCode",{parentName:"li"},"supposed: true")," property"),(0,i.kt)("li",{parentName:"ol"},"You can guarantee the same exact render on server and client only in case ",(0,i.kt)("inlineCode",{parentName:"li"},"synchronized: true"))),(0,i.kt)("h2",{id:"api"},"Api"),(0,i.kt)("h3",{id:"stores"},"Stores"),(0,i.kt)("h4",{id:"useragent"},"userAgent"),(0,i.kt)("p",null,"Stores the result of the user-agent string or client-hints headers parsing."),(0,i.kt)("h4",{id:"media"},"media"),(0,i.kt)("p",null,"Stores the media information about type and size of the client screen."),(0,i.kt)("h3",{id:"media-helpers"},"media helpers"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"media")," store has next data:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx"},"type Media = {\n  width: number;\n  height: number;\n  isTouch: boolean;\n  retina: boolean;\n  supposed?: boolean;\n  synchronized?: boolean;\n};\n")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"fromClientHints(media: Media): boolean")," - returns true if media data is synchronized on client and server"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"isSupposed(media: Media): boolean")," - returns true if media data are determined on server by the user-agent string and will be changes on the client"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"isRetina(media: Media): boolean")," - returns true if pixel density is equal to 2 or higher"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"useMedia(): Media")," - returns current state of the ",(0,i.kt)("inlineCode",{parentName:"p"},"media")," store"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"useFromClientHints(): boolean")," - calculates fromClientHints"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"useIsSupposed(): boolean")," - calculates isSupposed"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"useIsRetina(): boolean")," - calculates isRetina"),(0,i.kt)("h2",{id:"how-to"},"How to"),(0,i.kt)("h3",{id:"render-skeleton-only-when-user-loads-pages-first-time"},"Render skeleton only when user loads pages first time"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx"},"const App = () => {\n  const isSupposed = useIsSupposed();\n\n  if (isSupposed) {\n    return <AdaptiveSliderSkeleton />;\n  }\n\n  return <AdaptiveSlider />;\n};\n")),(0,i.kt)("h3",{id:"render-adaptive-component-on-first-time-and-on-subsequent-loads-render-specific-component"},"Render adaptive component on first time and on subsequent loads render specific component"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx"},"const App = () => {\n  const media = useMedia();\n  const fromClientHints = useFromClientHints();\n\n  let Block = AdaptiveBlock;\n\n  if (fromClientHints) {\n    Block = media.width >= 1024 ? DesktopBlock : MobileBlock;\n  }\n\n  return <Block />;\n};\n")),(0,i.kt)("h2",{id:"exported-tokens"},"Exported tokens"),(0,i.kt)("h3",{id:"user_agent_token"},"USER_AGENT_TOKEN"),(0,i.kt)("p",null,"Object as a result of parsing user-agent string with ",(0,i.kt)("a",{parentName:"p",href:"/docs/references/libs/user-agent"},"@tinkoff/user-agent"),". Parsing happens only on server-side and parsed info is reused on client-side."))}f.isMDXComponent=!0}}]);