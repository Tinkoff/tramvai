"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[2512],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var c=a.createContext({}),s=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},p=function(e){var t=s(e.components);return a.createElement(c.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,c=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),u=s(n),m=i,h=u["".concat(c,".").concat(m)]||u[m]||d[m]||o;return n?a.createElement(h,r(r({ref:t},p),{},{components:n})):a.createElement(h,r({ref:t},p))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=u;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l.mdxType="string"==typeof e?e:i,r[1]=l;for(var s=2;s<o;s++)r[s]=n[s];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},4915:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>c,default:()=>m,frontMatter:()=>l,metadata:()=>s,toc:()=>d});var a=n(7462),i=n(3366),o=(n(7294),n(3905)),r=["components"],l={id:"action",title:"Actions"},c=void 0,s={unversionedId:"features/data-fetching/action",id:"features/data-fetching/action",title:"Actions",description:"Explanation",source:"@site/tmp-docs/03-features/09-data-fetching/01-action.md",sourceDirName:"03-features/09-data-fetching",slug:"/features/data-fetching/action",permalink:"/docs/features/data-fetching/action",draft:!1,editUrl:"https://github.com/Tinkoff/tramvai/-/edit/master/docs/get-started/overview.md/tmp-docs/03-features/09-data-fetching/01-action.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{id:"action",title:"Actions"},sidebar:"sidebar",previous:{title:"State Management",permalink:"/docs/features/state-management"},next:{title:"HTTP Client",permalink:"/docs/features/data-fetching/http-client"}},p={},d=[{value:"Explanation",id:"explanation",level:2},{value:"Interface",id:"interface",level:3},{value:"Lifecycle",id:"lifecycle",level:3},{value:"Global actions",id:"global-actions",level:3},{value:"Features",id:"features",level:2},{value:"Execution Deadline",id:"execution-deadline",level:3},{value:"Synchronizing between server and client",id:"synchronizing-between-server-and-client",level:3},{value:"Recommendations",id:"recommendations",level:2},{value:"Quick Start",id:"quick-start",level:2},{value:"Usage",id:"usage",level:2},{value:"Page actions",id:"page-actions",level:3},{value:"Application actions",id:"application-actions",level:3},{value:"Execute actions in React components",id:"execute-actions-in-react-components",level:3},{value:"Parameters",id:"parameters",level:3},{value:"Context",id:"context",level:3},{value:"Dependencies",id:"dependencies",level:3},{value:"AbortController",id:"abortcontroller",level:3},{value:"Conditions",id:"conditions",level:3},{value:"Adding new conditions to the application",id:"adding-new-conditions-to-the-application",level:4},{value:"Example of a constraint",id:"example-of-a-constraint",level:4},{value:"Connecting conditions to the app",id:"connecting-conditions-to-the-app",level:4},{value:"Predefined presets",id:"predefined-presets",level:4},{value:"Dynamic parameters and SPA-transitions",id:"dynamic-parameters-and-spa-transitions",level:3},{value:"- Next: HTTP Client",id:"--next-http-client",level:5}],u={toc:d};function m(e){var t=e.components,n=(0,i.Z)(e,r);return(0,o.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"explanation"},"Explanation"),(0,o.kt)("p",null,"Actions is the standard way to perform any side-effects in the application, including:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"making requests"),(0,o.kt)("li",{parentName:"ul"},"dispatching store events"),(0,o.kt)("li",{parentName:"ul"},"redirects and navigation"),(0,o.kt)("li",{parentName:"ul"},"logging and analytics")),(0,o.kt)("p",null,"There is two ways to execute actions - automatically (we call it ",(0,o.kt)("a",{parentName:"p",href:"#global-actions"},(0,o.kt)("strong",{parentName:"a"},"global actions")),", usually it is ",(0,o.kt)("strong",{parentName:"p"},"page actions"),") and manually, in React components or nested calls inside another actions."),(0,o.kt)("p",null,"Actions have a lot of optimizations for achieving the best latency for application server responses."),(0,o.kt)("h3",{id:"interface"},"Interface"),(0,o.kt)("p",null,"You can find ",(0,o.kt)("inlineCode",{parentName:"p"},"declareAction")," interface in ",(0,o.kt)("a",{parentName:"p",href:"/docs/references/tramvai/core#declareaction"},(0,o.kt)("inlineCode",{parentName:"a"},"@tramvai/core")," package documentation")),(0,o.kt)("h3",{id:"lifecycle"},"Lifecycle"),(0,o.kt)("p",null,"Actions can be executed at different stages:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Server-side, for every request"),(0,o.kt)("li",{parentName:"ul"},"Client-side, after page initialization"),(0,o.kt)("li",{parentName:"ul"},"Client-side, after SPA transition"),(0,o.kt)("li",{parentName:"ul"},"Anywhere manually")),(0,o.kt)("p",null,"By default, all global actions will be executed by ",(0,o.kt)("a",{parentName:"p",href:"/docs/features/routing/overview"},"router")," on the server in parallel, at ",(0,o.kt)("a",{parentName:"p",href:"/docs/features/app-lifecycle#resolve_page_deps"},"resolvePageDeps")," ",(0,o.kt)("inlineCode",{parentName:"p"},"commandLineRunner")," stage, before page rendering."),(0,o.kt)("p",null,"This behaviour can be changed by actions ",(0,o.kt)("a",{parentName:"p",href:"#conditions"},"conditions")," or in the case of exceeded ",(0,o.kt)("a",{parentName:"p",href:"#execution-deadline"},"execution time")," or ",(0,o.kt)("a",{parentName:"p",href:"#synchronizing-between-server-and-client"},"errors")),(0,o.kt)("p",null,"Client-side actions behaviour is visualized in ",(0,o.kt)("a",{parentName:"p",href:"/docs/features/routing/flow"},"Navigation Flow page")),(0,o.kt)("h3",{id:"global-actions"},"Global actions"),(0,o.kt)("p",null,"In short, action is global if added via ",(0,o.kt)("inlineCode",{parentName:"p"},"createApp")," or a static property of a page component, such as ",(0,o.kt)("inlineCode",{parentName:"p"},"MainPage.actions"),". Only for this kind of actions some features will be available, for example, parallel execution and ",(0,o.kt)("a",{parentName:"p",href:"#execution-deadline"},"execution deadline"),"."),(0,o.kt)("p",null,"You can imagine global actions as flat list of async operations, and for every page their own list will be created and executed for every request."),(0,o.kt)("p",null,"Also, some ",(0,o.kt)("a",{parentName:"p",href:"#conditions"},"conditions")," will be applied only to global actions."),(0,o.kt)("h2",{id:"features"},"Features"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#lifecycle"},"Parallel execution")," - all global actions will be executed on the same time"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#execution-deadline"},"Execution deadline")," - global actions have a short server-side timeout with ",(0,o.kt)("a",{parentName:"li",href:"#synchronizing-between-server-and-client"},"client synchronization")),(0,o.kt)("li",{parentName:"ul"},"Error tolerance - failed actions will be skipped and ",(0,o.kt)("a",{parentName:"li",href:"#synchronizing-between-server-and-client"},"synchronized with the client")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"/docs/concepts/di"},"Dependency Injection")," - easy access to all application ",(0,o.kt)("a",{parentName:"li",href:"/docs/concepts/provider"},"DI providers")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#conditions"},"Conditions")," - you can specify conditions for executing actions, for example, run some only in the browser")),(0,o.kt)("h3",{id:"execution-deadline"},"Execution Deadline"),(0,o.kt)("p",null,"Servers must respond quickly, so we must reduce the number of cases when global actions cause a delay in page loading, for example, if an API fails. To do this, there is a time limit (",(0,o.kt)("inlineCode",{parentName:"p"},"500ms"),") on the server for executing global actions, and if this time passes, then waiting for actions ends and these actions must be executed on the client side."),(0,o.kt)("h3",{id:"synchronizing-between-server-and-client"},"Synchronizing between server and client"),(0,o.kt)("p",null,"Information about all successfully executed actions will be transferred to the client, which will start the execution of global actions based on this information. At the same time, if an action, for example, fell out of the deadline or fell by mistake, then it will be re-executed on the client side."),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"Unique actions names are required for correct synchronization between server and client")),(0,o.kt)("h2",{id:"recommendations"},"Recommendations"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"For API calls, always try to separate the business and requests logic from actions in favour of specific services, which can be used in actions or ",(0,o.kt)("a",{parentName:"li",href:"/docs/references/modules/react-query"},"React-Query")),(0,o.kt)("li",{parentName:"ul"},"Actions is the good place to combine fetching and state management logic"),(0,o.kt)("li",{parentName:"ul"},"Try to create actions with unique names, because they will be used for ",(0,o.kt)("a",{parentName:"li",href:"#synchronizing-between-server-and-client"},"synchronization between server and client")),(0,o.kt)("li",{parentName:"ul"},"Subscribe to ",(0,o.kt)("a",{parentName:"li",href:"#abortcontroller"},"abortSignal")," if you make requests in actions")),(0,o.kt)("h2",{id:"quick-start"},"Quick Start"),(0,o.kt)("p",null,"\u231b Create a new action:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"import { declareAction } from '@tramvai/core';\n\nconst logAction = declareAction({\n  name: 'log',\n  fn() {\n    console.log('logged!');\n  },\n});\n")),(0,o.kt)("p",null,"\u231b Register action for page component:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"import type { PageComponent } from '@tramvai/react';\n\nconst MainPage: PageComponent = () => <h1>Main Page</h1>;\n\n// highlight-next-line\nMainPage.actions = [logAction];\n\nexport default MainPage;\n")),(0,o.kt)("p",null,"This action will be executed only for this page and only on the server-side (because of ",(0,o.kt)("a",{parentName:"p",href:"#synchronizing-between-server-and-client"},"synchronization"),")."),(0,o.kt)("h2",{id:"usage"},"Usage"),(0,o.kt)("h3",{id:"page-actions"},"Page actions"),(0,o.kt)("p",null,"The most common way to use actions - is to fetch some data from API for specific page."),(0,o.kt)("p",null,"You need to use ",(0,o.kt)("inlineCode",{parentName:"p"},"actions")," static property of ",(0,o.kt)("a",{parentName:"p",href:"/docs/features/pages#actions"},"page components")," to declare ",(0,o.kt)("strong",{parentName:"p"},"global")," actions which will be executed only for this page."),(0,o.kt)("p",null,"Actions execution result will not be connected with page directly, and you need to create specific ",(0,o.kt)("a",{parentName:"p",href:"/docs/features/state-management#reducer"},"reducer")," for this data as transport layer between action and page component."),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("a",{parentName:"p",href:"/docs/references/modules/react-query"},"React-Query")," is the great tool to reduce boilerplate for fetching data with interface similar to ",(0,o.kt)("inlineCode",{parentName:"p"},"declareAction"))),(0,o.kt)("p",null,"Example with data fetching and custom reducer, let's imagine that we create a chat page:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"import type { PageComponent } from '@tramvai/react';\nimport { createReducer, createEvent, useStore } from '@tramvai/state';\nimport { declareAction } from '@tramvai/core';\n\nexport const messagesLoaded = createEvent('messages loaded');\n\n// data will be saved here on the server and transferred to the client automatically\nexport const MessagesStore = createReducer<Message[]>('messages', []).on(\n  messagesLoaded,\n  (state, payload) => payload\n);\n\n// action will be executed at server-side\nconst loadMessagesAction = declareAction({\n  name: 'load-messages',\n  async fn() {\n    const messages = await loadMessagesFromApi();\n\n    this.context.dispatch(messagesLoaded(messages));\n  },\n});\n\nconst ChatPage: PageComponent = () => {\n  // page will be rendered with the same data on the server and hydrated on the client\n  const messages = useStore(MessagesStore);\n\n  return (\n    <>\n      <h1>Messages</h1>\n      {messages.map((message) => (\n        <Message key={message.id} text={message.text} />\n      ))}\n    </>\n  );\n};\n\n// reducer and action will be registered only for this page\nChatPage.reducers = [MessagesStore];\nChatPage.actions = [loadMessagesAction];\n\nexport default ChatPage;\n")),(0,o.kt)("h3",{id:"application-actions"},"Application actions"),(0,o.kt)("p",null,"Another way to register ",(0,o.kt)("strong",{parentName:"p"},"global")," actions is to register them in the application level in ",(0,o.kt)("inlineCode",{parentName:"p"},"createApp")," method. This actions will be executed for every application page:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"createApp({\n  name: 'awesome-app',\n  actions: [loadSomeGlobalConfiguration],\n});\n")),(0,o.kt)("p",null,"Also you can register application-wide action with ",(0,o.kt)("inlineCode",{parentName:"p"},"ACTIONS_LIST_TOKEN")," - it is useful when you want to separate some global logic in independed module:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"import { provide } from '@tramvai/core';\nimport { ACTIONS_LIST_TOKEN } from '@tramvai/core';\n\nconst provider = provide({\n  provide: ACTIONS_LIST_TOKEN,\n  multi: true,\n  useValue: [loadSomeGlobalConfiguration],\n});\n")),(0,o.kt)("h3",{id:"execute-actions-in-react-components"},"Execute actions in React components"),(0,o.kt)("p",null,"Use ",(0,o.kt)("a",{parentName:"p",href:"/docs/features/state-management#useactions"},(0,o.kt)("inlineCode",{parentName:"a"},"useActions"))," hook if you want to execute actions manually."),(0,o.kt)("h3",{id:"parameters"},"Parameters"),(0,o.kt)("p",null,"When you declare action, you can declare ",(0,o.kt)("inlineCode",{parentName:"p"},"fn(...args: any[])")," property with any amount of arguments, and then you can pass it to action when you execute it:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"import { declareAction } from '@tramvai/core';\nimport { useActions } from '@tramvai/state';\n\nconst loadProductAction = declareAction({\n  name: 'load-product',\n  // declare typed params\n  async fn(id: number, timeout = 1000) {\n    return fetchProductById(id, { timeout });\n  },\n});\n\nconst ProductCard = ({ id }: { id: number }) => {\n  const [product, setProduct] = useState(null);\n  // bind action to the context\n  const loadProduct = useActions(loadProductAction);\n\n  useEffect(() => {\n    // pass nessesary params\n    loadProduct(id).then((response) => {\n      setProduct(response);\n    });\n  }, [id]);\n\n  return <>...</>;\n}\n")),(0,o.kt)("h3",{id:"context"},"Context"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"/docs/features/state-management#context"},"ConsumerContext")," is available in the action ",(0,o.kt)("inlineCode",{parentName:"p"},"fn")," function in ",(0,o.kt)("inlineCode",{parentName:"p"},"this")," context."),(0,o.kt)("p",null,"With Context for example you can execute nested actions inside global, or dispatch store ",(0,o.kt)("a",{parentName:"p",href:"/docs/features/state-management#event"},"events"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"import { declareAction } from '@tramvai/core';\nimport type { PageComponent } from '@tramvai/react';\n\nconst nestedAction = declareAction({\n  name: 'nested',\n  async fn() {\n    await doAsyncStuff();\n  }\n});\n\nconst rootAction = declareAction({\n  name: 'root',\n  async fn() {\n    // highlight-next-line\n    await this.executeAction(nestedAction);\n\n    // highlight-next-line\n    this.dispatch(someEvent());\n  }\n});\n\nconst MainPage: PageComponent = () => <h1>Main Page</h1>;\n\nMainPage.actions = [rootAction];\n\nexport default MainPage;\n")),(0,o.kt)("h3",{id:"dependencies"},"Dependencies"),(0,o.kt)("p",null,"Actions has full Dependency Injection support, so you can declare dependencies like in ",(0,o.kt)("a",{parentName:"p",href:"/docs/concepts/provider"},"DI providers"),", in ",(0,o.kt)("inlineCode",{parentName:"p"},"deps")," property. This dependencies will be available in the action ",(0,o.kt)("inlineCode",{parentName:"p"},"fn")," function in ",(0,o.kt)("inlineCode",{parentName:"p"},"this.deps")," property."),(0,o.kt)("p",null,"For example, let's use ",(0,o.kt)("a",{parentName:"p",href:"/docs/references/libs/logger"},"tramvai logger")," inside action:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"import { declareAction } from '@tramvai/core';\nimport { LOGGER_TOKEN } from '@tramvai/tokens-common';\n\nconst logAction = declareAction({\n  name: 'log',\n  fn() {\n    // highlight-next-line\n    const { logger } = this.deps;\n\n    logger.info('logged!');\n  },\n  deps: {\n    logger: LOGGER_TOKEN,\n  },\n});\n")),(0,o.kt)("h3",{id:"abortcontroller"},"AbortController"),(0,o.kt)("p",null,"Any actions has their own execution context, which is regulated by the ",(0,o.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/en-US/docs/Web/API/AbortController"},"AbortController")," API. What does it mean for application developers:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"You can subscribe to parent abort signal through ",(0,o.kt)("inlineCode",{parentName:"li"},"this.abortSignal")," in action ",(0,o.kt)("inlineCode",{parentName:"li"},"fn")," function"),(0,o.kt)("li",{parentName:"ul"},"You can cancel requests in nested actions through ",(0,o.kt)("inlineCode",{parentName:"li"},"this.abortController.abort()")," in action ",(0,o.kt)("inlineCode",{parentName:"li"},"fn")," function")),(0,o.kt)("p",null,"Subscription to ",(0,o.kt)("inlineCode",{parentName:"p"},"this.abortSignal")," is important, because when execution timeout will be exceeded, this actions will be ignored, and can make some unnecessary work on the server-side. Also it allows to control nested actions."),(0,o.kt)("p",null,"For example, we want to subscribe ",(0,o.kt)("inlineCode",{parentName:"p"},"this.abortSignal"),", and force some deadline for nested action:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"const innerAction = declareAction(/** ... */);\n\nconst action = declareAction({\n  name: 'root',\n  async fn() {\n    // after timeout exceeds, first request or request in innerAction will be aborted\n    setTimeout(() => {\n      this.abortController.abort()\n    }, 1000);\n\n    const { payload } = await this.deps.httpClient.request({\n      url: 'https://www.domain.com/api/endpoint',\n      // pass signal to the request\n      signal: this.abortSignal,\n    });\n\n    // if innerAction1 ends after abortController.abort was called\n    // then calling innerAction2 will throw an instance of ExecutionAbortError\n    await this.executeAction(innerAction, payload);\n  },\n  deps: {\n    httpClient: HTTP_CLIENT,\n  },\n});\n")),(0,o.kt)("h3",{id:"conditions"},"Conditions"),(0,o.kt)("p",null,"Not all actions can be executed under all circumstances, i.e. we can have actions that should be executed only on the server, others only in the browser, and having any other conditions. There is a ",(0,o.kt)("inlineCode",{parentName:"p"},"conditions")," property to solve this problem:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"declareAction({\n  name: 'fetch-data',\n  fn() {\n    return fetch(payload.url);\n  },\n  conditions: {\n    // highlight-next-line\n    onlyBrowser: true,\n  },\n});\n")),(0,o.kt)("p",null,"In the example above, we create an action that will be executed only in the browser."),(0,o.kt)("h4",{id:"adding-new-conditions-to-the-application"},"Adding new conditions to the application"),(0,o.kt)("p",null,"You can implement your own execution conditions in an application or module. To do this, we must create an object with an interface:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"interface Condition {\n  key: string;\n  fn(checker: ActionConditionChecker): void;\n}\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"key")," - restriction identifier"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"fn")," - a validation function that will be called for each action")),(0,o.kt)("p",null,"The function will receive in the argument checker, which has an interface"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"interface ActionConditionChecker {\n  payload: any;\n  parameters: any;\n  type: 'global' | 'local';\n  conditions: Record<string, any>;\n  forbid(): void;\n  setState(value: any): void;\n  getState(): any;\n  allow(): void;\n}\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"payload")," - data that was transferred with the action"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"parameters")," - parameters that were passed when creating the action"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"conditions")," - conditions for the current action"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"type")," - type of the executed action, can be global or simple execution via executeAction"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"forbid")," - prohibits the execution of the action. If at least one checker calls this function, the action execution will be stopped"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"setState")," - allows you to write the check data. It is necessary for cases when we need to know with what data it was executed before and whether it needs to be repeated, for example, conditions on the authorization role"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"getState")," - get the previously recorded state"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"allow")," - tell the action to be executed always. The action will execute unless execution is forbidden via ",(0,o.kt)("inlineCode",{parentName:"li"},"forbid"))),(0,o.kt)("h4",{id:"example-of-a-constraint"},"Example of a constraint"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"const isServer = typeof window === 'undefined';\n\nexport const onlyServer: ActionCondition = {\n  key: 'onlyServer',\n  fn: (checker) => {\n    if (checker.conditions.onlyServer && !isServer) {\n      checker.forbid();\n    }\n  },\n};\n")),(0,o.kt)("p",null,"After connecting, the constraint will look if the action has a ",(0,o.kt)("inlineCode",{parentName:"p"},"onlyServer")," field in ",(0,o.kt)("inlineCode",{parentName:"p"},"conditions"),", and if so, it will change the action's behavior"),(0,o.kt)("h4",{id:"connecting-conditions-to-the-app"},"Connecting conditions to the app"),(0,o.kt)("p",null,"To do this, you need to add the ",(0,o.kt)("inlineCode",{parentName:"p"},"multi")," provider ",(0,o.kt)("inlineCode",{parentName:"p"},"ACTION_CONDITIONALS")," and pass a function that will have an interface"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"import { provide } from '@tramvai/core';\n\nconst provider = provide({\n  provide: ACTION_CONDITIONALS,\n  multi: true,\n  useValue: [onlyServer],\n});\n")),(0,o.kt)("h4",{id:"predefined-presets"},"Predefined presets"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("em",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"em"},"always"))," - the action is executed on the server, then in the browser and on each SPA transition within the application"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("em",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"em"},"onlyBrowser"))," - the action is executed only in the browser"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("em",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"em"},"onlyServer"))," - the action is executed only on the server"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("em",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"em"},"pageBrowser"))," - the ",(0,o.kt)("a",{parentName:"li",href:"#global-actions"},"global")," action is executed only in the browser"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("em",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"em"},"pageServer"))," - the ",(0,o.kt)("a",{parentName:"li",href:"#global-actions"},"global")," action is executed only on the server"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("em",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"em"},"always"))," + ",(0,o.kt)("em",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"em"},"onlyBrowser"))," - the action is executed in the browser and for each SPA transition within the application")),(0,o.kt)("h3",{id:"dynamic-parameters-and-spa-transitions"},"Dynamic parameters and SPA-transitions"),(0,o.kt)("p",null,"Keep in mind that actions are ",(0,o.kt)("strong",{parentName:"p"},"cached")," by default and are only executed ",(0,o.kt)("strong",{parentName:"p"},"once")," during the life cycle of the application."),(0,o.kt)("p",null,"The following feature follows from this."),(0,o.kt)("p",null,"Let's assume the following situation:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"we have a page of the concert venue at the url ",(0,o.kt)("inlineCode",{parentName:"li"},"/concertvenue-[objectId]")," - where ",(0,o.kt)("inlineCode",{parentName:"li"},"objectId")," is a parameter that corresponds to the concert venue identifier;"),(0,o.kt)("li",{parentName:"ul"},"on this page we have one component ",(0,o.kt)("inlineCode",{parentName:"li"},"ConcertVenuePage")," and one page action ",(0,o.kt)("inlineCode",{parentName:"li"},"preparePageAction"),";"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"objectId")," in the url of the page is used to get data in ",(0,o.kt)("inlineCode",{parentName:"li"},"preparePageAction"),", as well as to fetch data for rendering the page;"),(0,o.kt)("li",{parentName:"ul"},"we have a concert page ",(0,o.kt)("inlineCode",{parentName:"li"},"/concert")," on which there are links to concert venues -",(0,o.kt)("inlineCode",{parentName:"li"},"/concertvenue-1"),", ",(0,o.kt)("inlineCode",{parentName:"li"},"/concertvenue-2"),", ",(0,o.kt)("inlineCode",{parentName:"li"},"/concertvenue-1"),". We can navigate to all these links with a SPA transition;"),(0,o.kt)("li",{parentName:"ul"},"Transitions between pages are client-side (SPA), not server-side;")),(0,o.kt)("p",null,"Sequencing:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"On the concert page we click on ",(0,o.kt)("inlineCode",{parentName:"li"},"/concertvenue-1"),", the page of the concert venue opens, the page action is performed ",(0,o.kt)("strong",{parentName:"li"},"for the first time"),"."),(0,o.kt)("li",{parentName:"ol"},"We go back to the SPA concert page by transition."),(0,o.kt)("li",{parentName:"ol"},"Click on ",(0,o.kt)("inlineCode",{parentName:"li"},"/concertvenue-2"),"."),(0,o.kt)("li",{parentName:"ol"},"We get to an empty page, since the page action has already ",(0,o.kt)("strong",{parentName:"li"},"been executed"),", new data has not been requested, and the data selection for drawing the page was made according to ID from url - 2.")),(0,o.kt)("p",null,"If you want a page action to be executed every time you visit the page, you need to pass it the appropriate condition:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"const preparePageAction = creareAction({\n  name: 'preparePageAction',\n  fn: () => {\n    // ...\n  },\n  conditions: {\n    // with always: true, the action will always be called and not cached\n    always: true,\n  },\n});\n\nConcertVenuePage.actions = [preparePageAction];\n")),(0,o.kt)("p",null,"Also, you can't pass ",(0,o.kt)("a",{parentName:"p",href:"#parameters"},"parameters")," to the global actions, because they are called automatically. Better way is to get nessessary parameter from DI, for example if action depends on ",(0,o.kt)("a",{parentName:"p",href:"/docs/features/routing/working-with-url#route-params"},"route dynamic parameter"),", you can use ",(0,o.kt)("inlineCode",{parentName:"p"},"PAGE_SERVICE_TOKEN"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"const preparePageAction = creareAction({\n  name: 'preparePageAction',\n  async fn() {\n    const { pageService } = this.deps;\n    const { id } = pageService.getCurrentRoute().params;\n\n    await loadConcert(id);\n  },\n  conditions: {\n    always: true,\n  },\n});\n\nConcertVenuePage.actions = [preparePageAction];\n")),(0,o.kt)("h5",{id:"--next-http-client"},"- ",(0,o.kt)("a",{parentName:"h5",href:"/docs/features/data-fetching/http-client"},"Next: HTTP Client")))}m.isMDXComponent=!0}}]);