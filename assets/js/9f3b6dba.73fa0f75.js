"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[4855],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var c=a.createContext({}),s=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},p=function(e){var t=s(e.components);return a.createElement(c.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,c=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),u=s(n),h=i,m=u["".concat(c,".").concat(h)]||u[h]||d[h]||o;return n?a.createElement(m,r(r({ref:t},p),{},{components:n})):a.createElement(m,r({ref:t},p))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=u;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l.mdxType="string"==typeof e?e:i,r[1]=l;for(var s=2;s<o;s++)r[s]=n[s];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},9181:(e,t,n)=>{n.r(t),n.d(t,{frontMatter:()=>l,contentTitle:()=>c,metadata:()=>s,toc:()=>p,default:()=>u});var a=n(7462),i=n(3366),o=(n(7294),n(3905)),r=["components"],l={id:"action",title:"Action",sidebar_position:6},c=void 0,s={unversionedId:"concepts/action",id:"concepts/action",title:"Action",description:"Actions are needed in the application to localize the execution of asynchronous actions, for example, make a request, update data in the store, and other actions that affect IO or state management.",source:"@site/tmp-docs/concepts/action.md",sourceDirName:"concepts",slug:"/concepts/action",permalink:"/docs/concepts/action",editUrl:"https://github.com/Tinkoff/tramvai/-/edit/master/docs/get-started/overview.md/tmp-docs/concepts/action.md",tags:[],version:"current",sidebarPosition:6,frontMatter:{id:"action",title:"Action",sidebar_position:6},sidebar:"sidebar",previous:{title:"CommandLineRunner",permalink:"/docs/concepts/command-line-runner"},next:{title:"Bundle",permalink:"/docs/concepts/bundle"}},p=[{value:"Example action",id:"example-action",children:[],level:2},{value:"Global Actions",id:"global-actions",children:[{value:"Execution Deadline",id:"execution-deadline",children:[],level:3},{value:"Synchronizing actions between server and client",id:"synchronizing-actions-between-server-and-client",children:[],level:3},{value:"Errors in actions",id:"errors-in-actions",children:[],level:3},{value:"Types of global actions",id:"types-of-global-actions",children:[{value:"Application-wide global actions",id:"application-wide-global-actions",children:[{value:"Connection",id:"connection",children:[],level:5}],level:4},{value:"Global actions for the bundle",id:"global-actions-for-the-bundle",children:[{value:"Connection",id:"connection-1",children:[],level:5}],level:4},{value:"Global actions linked to the page",id:"global-actions-linked-to-the-page",children:[{value:"Connection",id:"connection-2",children:[],level:5}],level:4}],level:3}],level:2},{value:"Restrictions",id:"restrictions",children:[{value:"Adding new restrictions to the application",id:"adding-new-restrictions-to-the-application",children:[],level:3},{value:"Example of a constraint",id:"example-of-a-constraint",children:[],level:3},{value:"Connecting restrictions to the application",id:"connecting-restrictions-to-the-application",children:[],level:3},{value:"Preset limits available for each action",id:"preset-limits-available-for-each-action",children:[],level:3}],level:2},{value:"Peculiarities",id:"peculiarities",children:[],level:2}],d={toc:p};function u(e){var t=e.components,n=(0,i.Z)(e,r);return(0,o.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"Actions are needed in the application to localize the execution of asynchronous actions, for example, make a request, update data in the store, and other actions that affect IO or state management."),(0,o.kt)("p",null,"Detailed description of the interface ",(0,o.kt)("a",{parentName:"p",href:"/docs/references/tramvai/core#declareAction"},"declareAction")),(0,o.kt)("h2",{id:"example-action"},"Example action"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"import { declareAction } from '@tramvai/core';\n\n// create an action\nconst actionFetchData = declareAction({\n  name: 'fetch-data',\n  fn(payload) {\n    return fetch(payload.url);\n  }\n});\n\n// execute the action\ncontext\n  .executeAction(actionFetchData, { url: 'https://tinkoff.ru' })\n  .then((data) => context.dispatch(loadData(data)));\n")),(0,o.kt)("h2",{id:"global-actions"},"Global Actions"),(0,o.kt)("p",null,"Applications can add global actions in the application that need to be executed before rendering the page, in these actions they usually load the information necessary to display the page, for example, information about deposits. Before rendering the page, the different types of actions are collected into a single list and executed in parallel."),(0,o.kt)("p",null,"In short, an action is global if added via ",(0,o.kt)("inlineCode",{parentName:"p"},"createApp"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"createBundle"),", or a static property of a page component, such as ",(0,o.kt)("inlineCode",{parentName:"p"},"PageComponent.actions"),". By default, global actions are executed once, on the server, and pass the status and result of the action to the client."),(0,o.kt)("h3",{id:"execution-deadline"},"Execution Deadline"),(0,o.kt)("p",null,"Servers must respond quickly, so we must reduce the number of cases when global actions cause a delay in page loading, for example, if an API fails. To do this, there is a time limit on the server for executing global actions, and if this time passes, then waiting for actions ends and these actions must be executed on the client side."),(0,o.kt)("h3",{id:"synchronizing-actions-between-server-and-client"},"Synchronizing actions between server and client"),(0,o.kt)("p",null,"Information about all successfully executed actions will be transferred to the client, which will start the execution of global actions based on this information. At the same time, if an action, for example, fell out of the deadline or fell by mistake, then it will be re-executed on the client side."),(0,o.kt)("h3",{id:"errors-in-actions"},"Errors in actions"),(0,o.kt)("p",null,"By default, errors in actions only logged with event ",(0,o.kt)("inlineCode",{parentName:"p"},"action-execution-error"),", but they do not stop the page rendering pipeline. The only exceptions are actions that throw ",(0,o.kt)("inlineCode",{parentName:"p"},"NotFoundError")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"RedirectFoundError")," errors from ",(0,o.kt)("inlineCode",{parentName:"p"},"@tinkoff/errors")," library."),(0,o.kt)("p",null,"When ",(0,o.kt)("inlineCode",{parentName:"p"},"new RedirectFoundError({ nextUrl })")," is thrown, the page request will be redirected to ",(0,o.kt)("inlineCode",{parentName:"p"},"nextUrl")," with ",(0,o.kt)("inlineCode",{parentName:"p"},"301")," status (default)."),(0,o.kt)("p",null,"When ",(0,o.kt)("inlineCode",{parentName:"p"},"new NotFoundError()")," is thrown, the page request will have a status of ",(0,o.kt)("inlineCode",{parentName:"p"},"404")," (default), and if your application has ",(0,o.kt)("inlineCode",{parentName:"p"},"not-found")," route, that route ",(0,o.kt)("strong",{parentName:"p"},"will not be render"),"."),(0,o.kt)("h3",{id:"types-of-global-actions"},"Types of global actions"),(0,o.kt)("h4",{id:"application-wide-global-actions"},"Application-wide global actions"),(0,o.kt)("p",null,"To register within the application, we must pass an array of actions to ",(0,o.kt)("a",{parentName:"p",href:"/docs/references/tramvai/core#createApp"},"createApp"),", after that all these actions will be executed for each page and any bundles:"),(0,o.kt)("h5",{id:"connection"},"Connection"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"createApp({\n  name: 'myApp',\n  actions: [loadDepositConfig],\n});\n")),(0,o.kt)("p",null,"You can also register actions with providers:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"import { ACTIONS_LIST_TOKEN } from '@tramvai/core';\nimport { provide } from '@tramvai/core';\n\nconst provider = provide({\n  provide: ACTIONS_LIST_TOKEN,\n  multi: true,\n  useValue: [loadDepositConfig],\n});\n")),(0,o.kt)("h4",{id:"global-actions-for-the-bundle"},"Global actions for the bundle"),(0,o.kt)("p",null,"To register inside a bundle, we must pass to ",(0,o.kt)("a",{parentName:"p",href:"/docs/references/tramvai/core#createBundle"},"createBundle")," a list of actions that will then be executed for all pages that are present and used in the bundle."),(0,o.kt)("h5",{id:"connection-1"},"Connection"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"createBundle({\n  name: 'bundle',\n  actions: [loadDepositConfig],\n});\n")),(0,o.kt)("h4",{id:"global-actions-linked-to-the-page"},"Global actions linked to the page"),(0,o.kt)("p",null,"This is the lowest level of adding global actions, for a separate Page component, we can bind a list of actions that need to be performed before rendering the page."),(0,o.kt)("h5",{id:"connection-2"},"Connection"),(0,o.kt)("p",null,"To do this, you need to add a static property to the page of the ",(0,o.kt)("inlineCode",{parentName:"p"},"actions")," component and pass the list of required actions"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"class PageComponent extends Copmponent {\n  static actions = [loadDepositConfig];\n}\n")),(0,o.kt)("h2",{id:"restrictions"},"Restrictions"),(0,o.kt)("p",null,"Not all actions can be executed under all circumstances, we can have actions that should be executed only on the server, others only in the browser, and having any other restrictions. There is a ",(0,o.kt)("inlineCode",{parentName:"p"},"conditions")," property to solve this problem:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"declareAction({\n  name: 'fetch-data',\n  fn() {\n    return fetch(payload.url);\n  },\n  conditions: {\n    requiredCoreRoles: ['client'],\n    onlyBrowser: true,\n  },\n});\n")),(0,o.kt)("p",null,"In the example above, we create an action that will be executed only in the browser and only when we have the user role of the main core API equal to ",(0,o.kt)("inlineCode",{parentName:"p"},"client"),"."),(0,o.kt)("h3",{id:"adding-new-restrictions-to-the-application"},"Adding new restrictions to the application"),(0,o.kt)("p",null,"You can implement your own constraints in an application or module. To do this, we must create an object with an interface:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"interface Condition {\n  key: string;\n  fn(checker: ActionConditionChecker): void;\n}\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"key")," - restriction identifier"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"fn")," - a validation function that will be called for each action")),(0,o.kt)("p",null,"The function will receive in the argument checker, which has an interface"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"interface ActionConditionChecker {\n  payload: any;\n  parameters: any;\n  type: 'global' | 'local';\n  conditions: Record<string, any>;\n  forbid(): void;\n  setState(value: any): void;\n  getState(): any;\n  allow(): void;\n}\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"payload")," - data that was transferred with the action"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"parameters")," - parameters that were passed when creating the action"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"conditions")," - restrictions for the current action"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"type")," - type of the executed action, can be global or simple execution via executeAction"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"forbid")," - prohibits the execution of the action. If at least one checker calls this function, the action execution will be stopped"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"setState")," - allows you to write the check data. It is necessary for cases when we need to know with what data it was executed before and whether it needs to be repeated, for example, restrictions on the authorization role"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"getState")," - getting the previously recorded state"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"allow")," - tell the action to be executed again. The action will execute unless execution is forbidden via ",(0,o.kt)("inlineCode",{parentName:"li"},"forbid"))),(0,o.kt)("h3",{id:"example-of-a-constraint"},"Example of a constraint"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"const isServer = typeof window === 'undefined';\n\nexport const onlyServer: ActionCondition = {\n  key: 'onlyServer',\n  fn: (checker) => {\n    if (checker.conditions.onlyServer && !isServer) {\n      checker.forbid();\n    }\n  },\n};\n")),(0,o.kt)("p",null,"After connecting, the constraint will look if the action has a ",(0,o.kt)("inlineCode",{parentName:"p"},"onlyServer")," field in ",(0,o.kt)("inlineCode",{parentName:"p"},"conditions"),", and if so, it will change the action's behavior"),(0,o.kt)("h3",{id:"connecting-restrictions-to-the-application"},"Connecting restrictions to the application"),(0,o.kt)("p",null,"To do this, you need to add the ",(0,o.kt)("inlineCode",{parentName:"p"},"multi")," provider ",(0,o.kt)("inlineCode",{parentName:"p"},"ACTION_CONDITIONALS")," and pass a function that will have an interface"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"import { provide } from '@tramvai/core';\n\nconst provider = provide({\n  provide: ACTION_CONDITIONALS,\n  multi: true,\n  useValue: [onlyServer],\n});\n")),(0,o.kt)("h3",{id:"preset-limits-available-for-each-action"},"Preset limits available for each action"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("em",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"em"},"always"))," - the action is executed on the server, then in the browser and on each SPA transition within the application"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("em",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"em"},"onlyBrowser"))," - the action is executed only in the browser"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("em",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"em"},"onlyServer"))," - the action is executed only on the server"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("em",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"em"},"pageBrowser"))," - the global action is executed only in the browser"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("em",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"em"},"pageServer"))," - the global action is executed only on the server"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("em",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"em"},"always"))," + ",(0,o.kt)("em",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"em"},"onlyBrowser"))," - the action is executed in the browser and for each SPA transition within the application")),(0,o.kt)("h2",{id:"peculiarities"},"Peculiarities"),(0,o.kt)("p",null,"Keep in mind that actions are ",(0,o.kt)("strong",{parentName:"p"},"cached")," by default and are only executed ",(0,o.kt)("strong",{parentName:"p"},"once")," during the life cycle of the application."),(0,o.kt)("p",null,"The following feature follows from this."),(0,o.kt)("p",null,"Let's assume the following situation:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"we have a page of the concert venue at the url ",(0,o.kt)("inlineCode",{parentName:"li"},"/concertvenue-[objectId]")," - where ",(0,o.kt)("inlineCode",{parentName:"li"},"objectId")," is a parameter that corresponds to the concert venue identifier;"),(0,o.kt)("li",{parentName:"ul"},"on this page we have one component ",(0,o.kt)("inlineCode",{parentName:"li"},"ConcertVenuePage")," and one page action ",(0,o.kt)("inlineCode",{parentName:"li"},"preparePageAction"),";"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"objectId")," in the url of the page is used to get data in ",(0,o.kt)("inlineCode",{parentName:"li"},"preparePageAction"),", as well as to fetch data for rendering the page;"),(0,o.kt)("li",{parentName:"ul"},"we have a concert page ",(0,o.kt)("inlineCode",{parentName:"li"},"/concert")," on which there are links to concert venues -",(0,o.kt)("inlineCode",{parentName:"li"},"/concertvenue-1"),", ",(0,o.kt)("inlineCode",{parentName:"li"},"/concertvenue-2"),", ",(0,o.kt)("inlineCode",{parentName:"li"},"/concertvenue-1"),". We can navigate to all these links with a SPA transition;"),(0,o.kt)("li",{parentName:"ul"},"Transitions between pages are client-side (SPA), not server-side;")),(0,o.kt)("p",null,"Sequencing:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"On the concert page we click on ",(0,o.kt)("inlineCode",{parentName:"li"},"/concertvenue-1"),", the page of the concert venue opens, the page action is performed ",(0,o.kt)("strong",{parentName:"li"},"for the first time"),"."),(0,o.kt)("li",{parentName:"ol"},"We go back to the SPA concert page by transition."),(0,o.kt)("li",{parentName:"ol"},"Click on ",(0,o.kt)("inlineCode",{parentName:"li"},"/concertvenue-2"),"."),(0,o.kt)("li",{parentName:"ol"},"We get to an empty page, since the page action has already ",(0,o.kt)("strong",{parentName:"li"},"been executed"),", new data has not been requested, and the data selection for drawing the page was made according to ID from url - 2.")),(0,o.kt)("p",null,"If you want a page action to be executed every time you visit the page, you need to pass it the appropriate condition:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"const preparePageAction = creareAction({\n  name: 'preparePageAction',\n  fn: () => {\n    // ...\n  },\n  conditions: {\n    // with always: true, the action will always be called and not cached\n    always: true,\n  },\n});\n\nConcertVenuePage.actions = [preparePageAction];\n")))}u.isMDXComponent=!0}}]);