"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[4736],{3905:(e,t,a)=>{a.d(t,{Zo:()=>u,kt:()=>m});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},u=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),d=p(a),m=r,h=d["".concat(s,".").concat(m)]||d[m]||c[m]||i;return a?n.createElement(h,o(o({ref:t},u),{},{components:a})):n.createElement(h,o({ref:t},u))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,o=new Array(i);o[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,o[1]=l;for(var p=2;p<i;p++)o[p]=a[p];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},5162:(e,t,a)=>{a.d(t,{Z:()=>o});var n=a(7294),r=a(6010);const i="tabItem_Ymn6";function o(e){var t=e.children,a=e.hidden,o=e.className;return n.createElement("div",{role:"tabpanel",className:(0,r.Z)(i,o),hidden:a},t)}},4866:(e,t,a)=>{a.d(t,{Z:()=>N});var n=a(7462),r=a(7294),i=a(6010),o=a(2466),l=a(6550),s=a(1980),p=a(7392),u=a(12);function c(e){return function(e){return r.Children.map(e,(function(e){if((0,r.isValidElement)(e)&&"value"in e.props)return e;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')}))}(e).map((function(e){var t=e.props;return{value:t.value,label:t.label,attributes:t.attributes,default:t.default}}))}function d(e){var t=e.values,a=e.children;return(0,r.useMemo)((function(){var e=null!=t?t:c(a);return function(e){var t=(0,p.l)(e,(function(e,t){return e.value===t.value}));if(t.length>0)throw new Error('Docusaurus error: Duplicate values "'+t.map((function(e){return e.value})).join(", ")+'" found in <Tabs>. Every value needs to be unique.')}(e),e}),[t,a])}function m(e){var t=e.value;return e.tabValues.some((function(e){return e.value===t}))}function h(e){var t=e.queryString,a=void 0!==t&&t,n=e.groupId,i=(0,l.k6)(),o=function(e){var t=e.queryString,a=void 0!==t&&t,n=e.groupId;if("string"==typeof a)return a;if(!1===a)return null;if(!0===a&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return null!=n?n:null}({queryString:a,groupId:n});return[(0,s._X)(o),(0,r.useCallback)((function(e){if(o){var t=new URLSearchParams(i.location.search);t.set(o,e),i.replace(Object.assign({},i.location,{search:t.toString()}))}}),[o,i])]}function f(e){var t,a,n,i,o=e.defaultValue,l=e.queryString,s=void 0!==l&&l,p=e.groupId,c=d(e),f=(0,r.useState)((function(){return function(e){var t,a=e.defaultValue,n=e.tabValues;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(a){if(!m({value:a,tabValues:n}))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+a+'" but none of its children has the corresponding value. Available values are: '+n.map((function(e){return e.value})).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");return a}var r=null!=(t=n.find((function(e){return e.default})))?t:n[0];if(!r)throw new Error("Unexpected error: 0 tabValues");return r.value}({defaultValue:o,tabValues:c})})),v=f[0],k=f[1],y=h({queryString:s,groupId:p}),b=y[0],g=y[1],w=(t=function(e){return e?"docusaurus.tab."+e:null}({groupId:p}.groupId),a=(0,u.Nk)(t),n=a[0],i=a[1],[n,(0,r.useCallback)((function(e){t&&i.set(e)}),[t,i])]),N=w[0],E=w[1],C=function(){var e=null!=b?b:N;return m({value:e,tabValues:c})?e:null}();return(0,r.useLayoutEffect)((function(){C&&k(C)}),[C]),{selectedValue:v,selectValue:(0,r.useCallback)((function(e){if(!m({value:e,tabValues:c}))throw new Error("Can't select invalid tab value="+e);k(e),g(e),E(e)}),[g,E,c]),tabValues:c}}var v=a(2389);const k="tabList__CuJ",y="tabItem_LNqP";function b(e){var t=e.className,a=e.block,l=e.selectedValue,s=e.selectValue,p=e.tabValues,u=[],c=(0,o.o5)().blockElementScrollPositionUntilNextRender,d=function(e){var t=e.currentTarget,a=u.indexOf(t),n=p[a].value;n!==l&&(c(t),s(n))},m=function(e){var t,a=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":var n,r=u.indexOf(e.currentTarget)+1;a=null!=(n=u[r])?n:u[0];break;case"ArrowLeft":var i,o=u.indexOf(e.currentTarget)-1;a=null!=(i=u[o])?i:u[u.length-1]}null==(t=a)||t.focus()};return r.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.Z)("tabs",{"tabs--block":a},t)},p.map((function(e){var t=e.value,a=e.label,o=e.attributes;return r.createElement("li",(0,n.Z)({role:"tab",tabIndex:l===t?0:-1,"aria-selected":l===t,key:t,ref:function(e){return u.push(e)},onKeyDown:m,onClick:d},o,{className:(0,i.Z)("tabs__item",y,null==o?void 0:o.className,{"tabs__item--active":l===t})}),null!=a?a:t)})))}function g(e){var t=e.lazy,a=e.children,n=e.selectedValue;if(a=Array.isArray(a)?a:[a],t){var i=a.find((function(e){return e.props.value===n}));return i?(0,r.cloneElement)(i,{className:"margin-top--md"}):null}return r.createElement("div",{className:"margin-top--md"},a.map((function(e,t){return(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==n})})))}function w(e){var t=f(e);return r.createElement("div",{className:(0,i.Z)("tabs-container",k)},r.createElement(b,(0,n.Z)({},e,t)),r.createElement(g,(0,n.Z)({},e,t)))}function N(e){var t=(0,v.Z)();return r.createElement(w,(0,n.Z)({key:String(t)},e))}},1257:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>d,contentTitle:()=>u,default:()=>f,frontMatter:()=>p,metadata:()=>c,toc:()=>m});var n=a(7462),r=a(3366),i=(a(7294),a(3905)),o=a(4866),l=a(5162),s=["components"],p={title:"@tramvai/papi",sidebar_position:4},u=void 0,c={unversionedId:"references/tramvai/papi",id:"references/tramvai/papi",title:"@tramvai/papi",description:"Library for creating and working with papi handlers. More on papi feature you can find here",source:"@site/tmp-docs/references/tramvai/papi.md",sourceDirName:"references/tramvai",slug:"/references/tramvai/papi",permalink:"/docs/references/tramvai/papi",draft:!1,editUrl:"https://github.com/Tinkoff/tramvai/-/edit/master/docs/get-started/overview.md/tmp-docs/references/tramvai/papi.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{title:"@tramvai/papi",sidebar_position:4},sidebar:"sidebar",previous:{title:"@tramvai/react",permalink:"/docs/references/tramvai/react"},next:{title:"@tramvai/react-query",permalink:"/docs/references/tramvai/react-query"}},d={},m=[{value:"Installation",id:"installation",level:2},{value:"Explanation",id:"explanation",level:2},{value:"Api",id:"api",level:2},{value:"createPapiMethod",id:"createpapimethod",level:3},{value:"handler",id:"handler",level:4},{value:"isPapiMethod",id:"ispapimethod",level:3},{value:"How to",id:"how-to",level:2},{value:"Create simple papi",id:"create-simple-papi",level:3},{value:"Use parameters of the request",id:"use-parameters-of-the-request",level:3},{value:"Settings headers and status",id:"settings-headers-and-status",level:3},{value:"Use deps",id:"use-deps",level:3},{value:"Use cache with deps",id:"use-cache-with-deps",level:3}],h={toc:m};function f(e){var t=e.components,a=(0,r.Z)(e,s);return(0,i.kt)("wrapper",(0,n.Z)({},h,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"Library for creating and working with papi handlers. More on papi feature you can find ",(0,i.kt)("a",{parentName:"p",href:"/docs/features/papi/introduction"},"here")),(0,i.kt)("h2",{id:"installation"},"Installation"),(0,i.kt)("p",null,"You need to install ",(0,i.kt)("inlineCode",{parentName:"p"},"@tramvai/papi")),(0,i.kt)(o.Z,{groupId:"npm2yarn",mdxType:"Tabs"},(0,i.kt)(l.Z,{value:"npm",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"npm i @tramvai/papi\n"))),(0,i.kt)(l.Z,{value:"yarn",label:"Yarn",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"yarn i @tramvai/papi\n# couldn't auto-convert command\n")))),(0,i.kt)("h2",{id:"explanation"},"Explanation"),(0,i.kt)("p",null,"Library mostly provides strong typings to papi handlers and most of the logic of integration it to the tramvai app is done by ",(0,i.kt)("a",{parentName:"p",href:"/docs/references/modules/server"},"@tramvai/module-server")),(0,i.kt)("h2",{id:"api"},"Api"),(0,i.kt)("h3",{id:"createpapimethod"},"createPapiMethod"),(0,i.kt)("p",null,"Options:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"path")," - specifies the path of url that current papi should handle. Required when specifying papi in tramvai DI, and not used when specified through file api."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"method"),' - specified HTTP-method that is acceptable by current papi. By default, it equals to "all"'),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"handler")," - see ",(0,i.kt)("a",{parentName:"li",href:"#handler"},"handler")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"deps")," - any DI deps that papi may require"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"options")," - additional options that controls how current papi works",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"timeout")," - timeout for executing current papi. If timeout exceeded request is resolved with Execution timeout error.")))),(0,i.kt)("h4",{id:"handler"},"handler"),(0,i.kt)("p",null,"Function that handles actual request and should return. It accepts the details of the request and should return the response"),(0,i.kt)("p",null,"Details of the request are passed with first parameter when handler is called. You can see available properties in typings when specifying papi method. It should provide most of the data that might be required to handle the request."),(0,i.kt)("p",null,"Additionally, though ",(0,i.kt)("inlineCode",{parentName:"p"},"this")," passed data that bounded to papi method:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"deps")," - resolved deps that were specified when defining papi method. Deps are resolved with ",(0,i.kt)("a",{parentName:"li",href:"/docs/concepts/di#container-is-a-child"},"Child DI Container"),", so do not use it for creating caches as it won't work."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"log")," - instance of ",(0,i.kt)("a",{parentName:"li",href:"/docs/references/modules/log#logger_token"},"LOGGER_TOKEN")," bounded with current papi method")),(0,i.kt)("h3",{id:"ispapimethod"},"isPapiMethod"),(0,i.kt)("p",null,"Type guard to check is passed object is papi handler"),(0,i.kt)("h2",{id:"how-to"},"How to"),(0,i.kt)("h3",{id:"create-simple-papi"},"Create simple papi"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx"},"import { createPapiMethod } from '@tramvai/papi';\n\nexport const papi = createPapiMethod({\n  // will handle requests to `/app/papi/my/papi` (actual url depends on setup)\n  path: '/my/papi',\n  // only requests with GET http method will be handled\n  method: 'get',\n  // function to return response to the client\n  async handler() {\n    return 'test';\n  },\n});\n")),(0,i.kt)("h3",{id:"use-parameters-of-the-request"},"Use parameters of the request"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx"},"import { createPapiMethod } from '@tramvai/papi';\n\nexport const papi = createPapiMethod({\n  async handler({ parsedUrl: { query }, cookies }) {\n    const { a, b } = query;\n    const { testCookie } = cookie;\n\n    return {\n      testCookie,\n      a,\n      b\n    };\n  },\n});\n")),(0,i.kt)("h3",{id:"settings-headers-and-status"},"Settings headers and status"),(0,i.kt)("p",null,"It can be done with ",(0,i.kt)("a",{parentName:"p",href:"/docs/references/tokens/common#responsemanager-tokens"},"responseManager")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx"},"import { createPapiMethod } from '@tramvai/papi';\n\nexport const papi = createPapiMethod({\n  async handler({ responseManager }) {\n    responseManager.setHeader('content-type', 'text/html');\n    responseManager.setStatus(200);\n\n    return `<html>...</html>`;\n  },\n});\n")),(0,i.kt)("h3",{id:"use-deps"},"Use deps"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx"},"import { createPapiMethod } from '@tramvai/papi';\n\nexport const papi = createPapiMethod({\n  async handler() {\n    const { cookieManager } = this.deps;\n\n    cookieManager.set({ name: 'b', value: 'abc', expires: 35 });\n\n    return \"response\";\n  },\n  deps: {\n    cookieManager: COOKIE_MANAGER_TOKEN,\n  }\n});\n")),(0,i.kt)("h3",{id:"use-cache-with-deps"},"Use cache with deps"),(0,i.kt)("p",null,"Deps are resolved with ChildContainer that means they are getting resolved on every request in order to provide request specific info. To use any of deps that should outlive scope of the request you should use provider that was initialized with ",(0,i.kt)("a",{parentName:"p",href:"/docs/concepts/di#root-container"},"scope=SINGLETON")),(0,i.kt)("p",null,"For example, if you want to use some papi specific cache you should create new token and provide the cache instance with that token and with option ",(0,i.kt)("inlineCode",{parentName:"p"},"scope: Scope.SINGLETON")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx"},"import { createToken, Scope, provide } from '@tinkoff/dippy'\nimport { createApp } from '@tramvai/core';\nimport { createPapiMethod } from '@tramvai/papi';\nimport { Cache, CREATE_CACHE_TOKEN } from '@tramvai/tokens-common';\n\nexport const PAPI_CACHE_TOKEN = createToken<Cache<string>>('app papi cache');\n\nconst app = createApp({\n  // ...,\n  providers: [\n    // ...,\n    provide({\n      provide: PAPI_CACHE_TOKEN,\n      scope: Scope.SINGLETON,\n      useFactory: ({ createCache }) => {\n        return createCache('memory');\n      },\n      deps: {\n        createCache: CREATE_CACHE_TOKEN,\n      },\n    })\n  ]\n});\n\nexport const papi = createPapiMethod({\n  async handler({ parsedUrl: { query } }) {\n    const { cacheKey } = query;\n    const { cache } = this.deps;\n\n    if (cache.has(cacheKey)) {\n      return cache.get(cacheKey);\n    }\n\n    const result = heavyComputation();\n\n    cache.set(cacheKey, result);\n\n    return result;\n  },\n  deps: {\n    cache: PAPI_CACHE_TOKEN\n  }\n});\n")))}f.isMDXComponent=!0}}]);