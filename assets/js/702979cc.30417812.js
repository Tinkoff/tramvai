"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[3639],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),p=c(n),m=r,h=p["".concat(l,".").concat(m)]||p[m]||d[m]||o;return n?a.createElement(h,i(i({ref:t},u),{},{components:n})):a.createElement(h,i({ref:t},u))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=p;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var c=2;c<o;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},6566:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>l,default:()=>m,frontMatter:()=>s,metadata:()=>c,toc:()=>d});var a=n(7462),r=n(3366),o=(n(7294),n(3905)),i=["components"],s={id:"state-management",title:"State Management"},l=void 0,c={unversionedId:"features/state-management",id:"features/state-management",title:"State Management",description:"@tramvai/state is a library built into tramvai for managing application state.",source:"@site/tmp-docs/03-features/08-state-management.md",sourceDirName:"03-features",slug:"/features/state-management",permalink:"/docs/features/state-management",draft:!1,editUrl:"https://github.com/Tinkoff/tramvai/-/edit/master/docs/get-started/overview.md/tmp-docs/03-features/08-state-management.md",tags:[],version:"current",sidebarPosition:8,frontMatter:{id:"state-management",title:"State Management"},sidebar:"sidebar",previous:{title:"Testing",permalink:"/docs/features/routing/testing"},next:{title:"Actions",permalink:"/docs/features/data-fetching/action"}},u={},d=[{value:"Features",id:"features",level:2},{value:"Concepts",id:"concepts",level:2},{value:"Recommendations",id:"recommendations",level:2},{value:"Quick Start",id:"quick-start",level:2},{value:"Store",id:"store",level:2},{value:"Interface",id:"interface",level:3},{value:"Usage",id:"usage",level:3},{value:"<code>getState()</code>",id:"getstate",level:4},{value:"<code>dispatch()</code>",id:"dispatch",level:4},{value:"<code>subscribe()</code>",id:"subscribe",level:4},{value:"Reducer",id:"reducer",level:2},{value:"Interface",id:"interface-1",level:3},{value:"Typing",id:"typing",level:3},{value:"Events subscription",id:"events-subscription",level:3},{value:"Automatic creation of events",id:"automatic-creation-of-events",level:3},{value:"Connecting reducers to the app",id:"connecting-reducers-to-the-app",level:3},{value:"Event",id:"event",level:2},{value:"Interface",id:"interface-2",level:3},{value:"Usage",id:"usage-1",level:3},{value:"Creating an event without parameters",id:"creating-an-event-without-parameters",level:4},{value:"Creating an event with parameters",id:"creating-an-event-with-parameters",level:4},{value:"Create event with payload conversion",id:"create-event-with-payload-conversion",level:4},{value:"Using Events in Actions",id:"using-events-in-actions",level:4},{value:"Context",id:"context",level:2},{value:"Interface",id:"interface-3",level:3},{value:"Usage",id:"usage-2",level:3},{value:"In providers",id:"in-providers",level:4},{value:"In actions",id:"in-actions",level:4},{value:"In components",id:"in-components",level:4},{value:"React Hooks",id:"react-hooks",level:2},{value:"<code>useStore()</code>",id:"usestore",level:3},{value:"Interface",id:"interface-4",level:4},{value:"Usage",id:"usage-3",level:4},{value:"<code>useSelector()</code>",id:"useselector",level:3},{value:"Interface",id:"interface-5",level:4},{value:"Usage",id:"usage-4",level:4},{value:"Optimizations",id:"optimizations",level:4},{value:"<code>useStoreSelector()</code>",id:"usestoreselector",level:3},{value:"Interface",id:"interface-6",level:4},{value:"Usage",id:"usage-5",level:4},{value:"Optimizations",id:"optimizations-1",level:4},{value:"<code>useActions()</code>",id:"useactions",level:3},{value:"Interface",id:"interface-7",level:4},{value:"Usage",id:"usage-6",level:4},{value:"<code>useConsumerContext()</code>",id:"useconsumercontext",level:3},{value:"Interface",id:"interface-8",level:4},{value:"Usage",id:"usage-7",level:4},{value:"<code>connect</code>",id:"connect",level:3},{value:"DevTools",id:"devtools",level:2},{value:"Possible problems",id:"possible-problems",level:3},{value:"Performance",id:"performance",level:3},{value:"Additional links",id:"additional-links",level:3},{value:"Testing",id:"testing",level:2},{value:"- Next: Actions",id:"--next-actions",level:5}],p={toc:d};function m(e){var t=e.components,n=(0,r.Z)(e,i);return(0,o.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"@tramvai/state")," is a library built into ",(0,o.kt)("inlineCode",{parentName:"p"},"tramvai")," for managing application state."),(0,o.kt)("h2",{id:"features"},"Features"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Redux-like state manager"),(0,o.kt)("li",{parentName:"ul"},"Built-in library similar to ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/pauldijou/redux-act"},"redux-act")," to reduce boilerplate code"),(0,o.kt)("li",{parentName:"ul"},"Contains bindings to ",(0,o.kt)("inlineCode",{parentName:"li"},"React")," components such as ",(0,o.kt)("inlineCode",{parentName:"li"},"useStore")," and ",(0,o.kt)("inlineCode",{parentName:"li"},"useSelector")),(0,o.kt)("li",{parentName:"ul"},"Dynamic initialization of reducers. You can register a reducer at any time or generate a new one"),(0,o.kt)("li",{parentName:"ul"},"Point subscriptions to changes in the states of reducers. When data changes, only the affected ",(0,o.kt)("inlineCode",{parentName:"li"},"useStore")," and ",(0,o.kt)("inlineCode",{parentName:"li"},"useSelector")," are recalculated, not everything"),(0,o.kt)("li",{parentName:"ul"},"Full SSR support")),(0,o.kt)("h2",{id:"concepts"},"Concepts"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#store"},"Store")," - A class that contains the state of all reducers, change subscriptions and is created for each client"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#context"},"Context")," - wrapper for the Store which extends Store API and add additional functionality for ",(0,o.kt)("a",{parentName:"li",href:"/docs/concepts/action"},"actions")," support"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#reducer"},"Reducers")," - entities in which we describe how data will be stored and transformed"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#event"},"Events")," - events with which you can change the states of reducers"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"/docs/concepts/action"},"Actions")," - functions that allow you to perform side effects and update data in the store. Similar to ",(0,o.kt)("inlineCode",{parentName:"li"},"redux-thunk"),". Actions is a separate mechanism and is not related directly to ",(0,o.kt)("inlineCode",{parentName:"li"},"@tramvai/state"))),(0,o.kt)("h2",{id:"recommendations"},"Recommendations"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Create unique names for reducers, otherwise conflicted reducers will be overwritten by last registered"),(0,o.kt)("li",{parentName:"ul"},"You mustn't mutate data in reducers. Otherwise, due to various optimizations, subscribers will not be notified about the changes"),(0,o.kt)("li",{parentName:"ul"},"Initialize reducers as early as possible and before using it. Otherwise, when calling ",(0,o.kt)("inlineCode",{parentName:"li"},"dispatch(userLoadInformation())"),", the reducer will not yet track events and will not receive data"),(0,o.kt)("li",{parentName:"ul"},"Do not store static data in stores. Since this data will be transferred from the server to the client, the data will be duplicated. Better to put in constants"),(0,o.kt)("li",{parentName:"ul"},"Break into small reducers. Otherwise, we have a huge reducer that contains a large amount of information and any changes will cause recalculations for a large number of components"),(0,o.kt)("li",{parentName:"ul"},"Use ",(0,o.kt)("a",{parentName:"li",href:"/docs/concepts/action"},"Actions")," to perform side effects and handle complex state changing logic")),(0,o.kt)("h2",{id:"quick-start"},"Quick Start"),(0,o.kt)("p",null,"\u231b Create new reducer:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"import { createReducer, createEvent } from '@tramvai/state';\n\nexport const increment = createEvent('increment');\nexport const decrement = createEvent('decrement');\n\nexport const CounterStore = createReducer('counter', 0)\n  .on(increment, (state, payload) => state + 1)\n  .on(decrement, (state, payload) => state - 1);\n")),(0,o.kt)("p",null,"\u231b Register reducer in application (global registration, for all pages):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="index.ts"',title:'"index.ts"'},"import { provide } from '@tramvai/core';\nimport { COMBINE_REDUCERS } from '@tramvai/tokens-common';\n\ncreateApp({\n  providers: [\n    provide({\n      provide: COMBINE_REDUCERS,\n      useValue: CounterStore,\n    }),\n  ],\n});\n")),(0,o.kt)("p",null,"\u231b Read and update reducer in component:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"import { useStore } from '@tramvai/state';\nimport { useDi } from '@tramvai/react';\nimport { STORE_TOKEN } from '@tramvai/tokens-common';\n\nexport const Component = () => {\n  // get Store instance from DI\n  const store = useDi(STORE_TOKEN);\n  // subscribe to counter reducer state\n  const counter = useStore(CounterStore);\n\n  // bind events to dispatch\n  const handleIncrement = () => store.dispatch(increment());\n  const handleDecrement = () => store.dispatch(decrement());\n\n  return (\n    <>\n      <h1>Count is: {counter}</h1>\n      <button onClick={handleIncrement}>increment</button>\n      <button onClick={handleDecrement}>decrement</button>\n    </>\n  );\n};\n")),(0,o.kt)("h2",{id:"store"},"Store"),(0,o.kt)("p",null,"Store instance is created for each client request and is available in the DI container by the token ",(0,o.kt)("inlineCode",{parentName:"p"},"STORE_TOKEN"),"."),(0,o.kt)("h3",{id:"interface"},"Interface"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"type Store = {\n  dispatch(event);\n  subscribe(listener);\n  subscribe(reducer, listener);\n  getState();\n  getState(reducer);\n};\n")),(0,o.kt)("h3",{id:"usage"},"Usage"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"STORE_TOKEN")," can be used in ",(0,o.kt)("a",{parentName:"p",href:"/docs/concepts/provider"},"providers"),", ",(0,o.kt)("a",{parentName:"p",href:"/docs/concepts/action"},"actions")," and components."),(0,o.kt)("p",null,"For example, we can work with Store in ",(0,o.kt)("a",{parentName:"p",href:"/docs/features/app-lifecycle"},"commandLineRunner stages"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"import { commandLineListTokens } from '@tramvai/core';\nimport { createEvent, createReducer } from '@tramvai/state';\nimport { STORE_TOKEN } from '@tramvai/tokens-common';\n\nconst provider = {\n  provide: commandLineListTokens.resolveUserDeps,\n  useFactory: ({ store }) => {\n    return function readCounterState() {\n      const counter = store.getState(CounterStore);\n    };\n  },\n  deps: {\n    store: STORE_TOKEN,\n  },\n};\n")),(0,o.kt)("h4",{id:"getstate"},(0,o.kt)("inlineCode",{parentName:"h4"},"getState()")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"store.getState()")," method is used to get the global state, or the state of a particular reducer."),(0,o.kt)("p",null,"If you want to get the state of all reducers, use ",(0,o.kt)("inlineCode",{parentName:"p"},"getState")," without arguments:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"const state = store.getState(); // { counter: 0 }\n")),(0,o.kt)("p",null,"Otherwise pass specific reducer to ",(0,o.kt)("inlineCode",{parentName:"p"},"getState"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"const counter = store.getState(CounterStore); // 0\n")),(0,o.kt)("h4",{id:"dispatch"},(0,o.kt)("inlineCode",{parentName:"h4"},"dispatch()")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"store.dispatch()")," method is used to change state through events (only subscribed to event reducers will be updated):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"store.dispatch(increment());\nconst counter = store.getState(CounterStore); // 1\n")),(0,o.kt)("h4",{id:"subscribe"},(0,o.kt)("inlineCode",{parentName:"h4"},"subscribe()")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"store.subscribe()")," method is used to subscribe to a global state change."),(0,o.kt)("p",null,"If you want to subscribe for all reducers updates, use ",(0,o.kt)("inlineCode",{parentName:"p"},"subscribe")," with one callback argument:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"let currentState = store.getState().counter;\n\nconst unsubscribe = store.subscribe((nextGlobalState) => {\n  const nextState = nextGlobalState.counter;\n\n  if (currentState !== nextState) {\n    console.log('counter is changed:', currentState);\n    currentState = nextState;\n  }\n});\n")),(0,o.kt)("p",null,"Otherwise pass specific reducer as first argument to ",(0,o.kt)("inlineCode",{parentName:"p"},"subscribe"),", and callback as second:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"let currentState = store.getState(CounterStore);\n\nconst unsubscribe = store.subscribe(CounterStore, (nextState) => {\n  console.log('counter is changed:', currentState);\n  currentState = nextState;\n});\n")),(0,o.kt)("h2",{id:"reducer"},"Reducer"),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"createReducer")," method creates reducer functions that describe the state during initialization and the reaction to state changes."),(0,o.kt)("p",null,"The working principle and api is built based on ",(0,o.kt)("a",{parentName:"p",href:"https://redux.js.org/basics/reducers"},"Redux reducers")," and the use interface from ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/pauldijou/redux-act#createreducerhandlers-defaultstate"},"redux-act")),(0,o.kt)("h3",{id:"interface-1"},"Interface"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"createReducer(name, initialState): Reducer")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"name")," - unique name of the reducer. Should not overlap with other reducers"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"initialState")," - default reducer state")),(0,o.kt)("h3",{id:"typing"},"Typing"),(0,o.kt)("p",null,"By default, the reducer state type and name are displayed automatically:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"import { createReducer } from '@tramvai/state';\n\nconst userReducer = createReducer('user', { name: 'anonymus' });\n")),(0,o.kt)("p",null,"Why do we need typing for the name of the reducer at all?\nThen this reducer will be more convenient to use together with ",(0,o.kt)("inlineCode",{parentName:"p"},"useSelector"),"."),(0,o.kt)("p",null,"If you pass the state type manually, it is desirable to specify the name as the second argument of the generic:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"import { createReducer } from '@tramvai/state';\n\ntype UserState = { name: string };\n\nconst userReducer = createReducer<UserState, 'user'>('user', { name: 'anonymus' });\n")),(0,o.kt)("p",null,"But, you can simply set the desired type for ",(0,o.kt)("inlineCode",{parentName:"p"},"initialState"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"import { createReducer } from '@tramvai/state';\n\ntype UserState = { name?: string };\n\nconst userReducer = createReducer('user', {} as UserState);\n")),(0,o.kt)("h3",{id:"events-subscription"},"Events subscription"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},".on(event, reducer)")," When creating a reducer, the .on method becomes available, which allows you to subscribe to events and return a new state."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"event")," - an event or a string to which the reducer will be subscribed"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"reducer(state, payload)")," - a pure function that takes the current ",(0,o.kt)("inlineCode",{parentName:"li"},"state"),", ",(0,o.kt)("inlineCode",{parentName:"li"},"payload")," from the event and must return the new state of the reducer")),(0,o.kt)("p",null,"Example of using the ",(0,o.kt)("inlineCode",{parentName:"p"},".on")," method:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"import { createReducer, createEvent } from '@tramvai/state';\n\nexport const userLoadInformation = createEvent<{ status: string }> 'user load information';\nexport const userAddInformation = createEvent<{ name: string, info: {} }> 'user add information';\n\nconst userReducer = createReducer('user', {\n  info: {},\n})\n  .on(userLoadInformation, (state, info) => ({ info }))\n  .on(userAddInformation, (state, { name, info }) => ({\n    ...state,\n    state: {\n      ...state.info,\n      [name]: info,\n    },\n  }));\n")),(0,o.kt)("h3",{id:"automatic-creation-of-events"},"Automatic creation of events"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},".createEvents(model)")," method that removes the need to create and explicitly bind events"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"model")," - an object in which the key is the event identifier, which will then be passed to ",(0,o.kt)("inlineCode",{parentName:"li"},"createEvent"),", and the value is the reducer function, which will get into the ",(0,o.kt)("inlineCode",{parentName:"li"},".on()")," method and will be called when the events are triggered")),(0,o.kt)("p",null,"Example of using the ",(0,o.kt)("inlineCode",{parentName:"p"},".createEvents")," method:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"import { createReducer } from '@tramvai/state';\n\nconst userReducer = createReducer('user', {\n  info: {},\n});\n\nexport const { userLoadInformation, userAddInformation } = userReducer.createEvents({\n  userLoadInformation: (state, info: { status: string }) => ({ info }),\n  userAddInformation: (state, { name, info }: { name: string; info: {} }) => ({\n    ...state,\n    state: {\n      ...state.info,\n      [name]: info,\n    },\n  }),\n});\n")),(0,o.kt)("p",null,"It is imperative to describe the types of the ",(0,o.kt)("inlineCode",{parentName:"p"},"payload")," argument in reducers, otherwise type inference for events will not work."),(0,o.kt)("h3",{id:"connecting-reducers-to-the-app"},"Connecting reducers to the app"),(0,o.kt)("p",null,"For global store registration, for all pages, you can provide ",(0,o.kt)("inlineCode",{parentName:"p"},"COMBINE_REDUCERS"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="index.ts"',title:'"index.ts"'},"import { provide } from '@tramvai/core';\nimport { COMBINE_REDUCERS } from '@tramvai/tokens-common';\n\ncreateApp({\n  providers: [\n    provide({\n      provide: COMBINE_REDUCERS,\n      useValue: CounterStore,\n    }),\n  ],\n});\n")),(0,o.kt)("p",null,"If you need reducer only for a specific page, you can pass it in the ",(0,o.kt)("a",{parentName:"p",href:"/docs/features/pages#reducers"},"Page")," or ",(0,o.kt)("a",{parentName:"p",href:"/docs/features/layouts#reducers"},"Nested Layout"),", in ",(0,o.kt)("inlineCode",{parentName:"p"},"reducers")," static property."),(0,o.kt)("h2",{id:"event"},"Event"),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"createEvent")," method creates an event that can be subscribed to in state management"),(0,o.kt)("h3",{id:"interface-2"},"Interface"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"createEvent(eventName: string, payloadCreator?: PayloadTransformer): EventCreator")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"eventName")," - Unique identifier of the event"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"payloadCreator")," - an optional function that allows you to combine multiple arguments into one, In cases where the event was called with multiple arguments.")),(0,o.kt)("h3",{id:"usage-1"},"Usage"),(0,o.kt)("h4",{id:"creating-an-event-without-parameters"},"Creating an event without parameters"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"import { createEvent } from '@tramvai/state';\n\nconst userLoadingInformation = createEvent('user loading information');\n\nuserLoadingInformation();\n")),(0,o.kt)("h4",{id:"creating-an-event-with-parameters"},"Creating an event with parameters"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"import { createEvent } from '@tramvai/state';\n\nconst userInformation = createEvent<{ age: number; name: string }>('user information');\n\nuserInformation({ age: 42, name: 'Tom' });\n")),(0,o.kt)("h4",{id:"create-event-with-payload-conversion"},"Create event with payload conversion"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"import { createEvent } from '@tramvai/state';\n\nconst itemPrice = createEvent('user information', (info: string, price: number) => ({\n  [info]: price,\n}));\n\nitemPrice('car', 3000);\n")),(0,o.kt)("h4",{id:"using-events-in-actions"},"Using Events in Actions"),(0,o.kt)("p",null,"In this example we will create an action in which, after loading the information, we create an event and pass it into ",(0,o.kt)("inlineCode",{parentName:"p"},"context.dispatch"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"import { declareAction } from '@tramvai/core';\nimport { createEvent } from '@tramvai/state';\n\nconst userInformation = createEvent < { age: number, name: string } > 'user information';\n\nconst action = declareAction({\n  name: 'userLoadInformation',\n  async fn() {\n    const result = await fetch('api/user/information');\n    this.dispatch(userInformation(result));\n  },\n});\n")),(0,o.kt)("h2",{id:"context"},"Context"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"ConsumerContext")," instance is created for each client request and is available in the DI container by the token ",(0,o.kt)("inlineCode",{parentName:"p"},"CONTEXT_TOKEN"),"."),(0,o.kt)("h3",{id:"interface-3"},"Interface"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"type ConsumerContext = {\n  executeAction(action, payload);\n  dispatch(event);\n  subscribe(listener);\n  subscribe(reducer, listener);\n  getState();\n  getState(reducer);\n};\n")),(0,o.kt)("h3",{id:"usage-2"},"Usage"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"CONTEXT_TOKEN")," can be used in ",(0,o.kt)("a",{parentName:"p",href:"/docs/concepts/provider"},"providers")," and components."),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"We recommend to prefer ",(0,o.kt)("inlineCode",{parentName:"p"},"STORE_TOKEN")," if you don't need to run actions, for consistency in the codebase")),(0,o.kt)("h4",{id:"in-providers"},"In providers"),(0,o.kt)("p",null,"For example, we can working with Context in ",(0,o.kt)("a",{parentName:"p",href:"/docs/features/app-lifecycle"},"commandLineRunner")," stages:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"import { commandLineListTokens } from '@tramvai/core';\nimport { createEvent, createReducer } from '@tramvai/state';\nimport { CONTEXT_TOKEN } from '@tramvai/tokens-common';\n\nconst provider = {\n  provide: commandLineListTokens.resolveUserDeps,\n  useFactory: ({ context }) => {\n    return function readCounterState() {\n      const counter = context.getState(CounterStore);\n    };\n  },\n  deps: {\n    context: CONTEXT_TOKEN,\n  },\n};\n")),(0,o.kt)("h4",{id:"in-actions"},"In actions"),(0,o.kt)("p",null,"Context methods will be available in action ",(0,o.kt)("inlineCode",{parentName:"p"},"fn")," property as ",(0,o.kt)("inlineCode",{parentName:"p"},"this")," context:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"import { declareAction } from '@tramvai/core';\nimport { createEvent, createReducer } from '@tramvai/state';\n\nconst loadUser = createEvent('load user');\nconst userReducer = createReducer('user', { name: 'anonymus' });\n\nuserReducer.on(loadUser, (state, payload) => payload);\n\nconst fetchUserAction = declareAction({\n  name: 'fetchUser',\n  async fn() {\n    // highlight-next-line\n    const { name } = this.getState(userReducer);\n\n    if (name !== 'anonymus') {\n      return;\n    }\n\n    const response = await this.deps.httpClient.get('/user');\n\n    // highlight-next-line\n    this.dispatch(loadUser(response.payload));\n  },\n  deps: {\n    httpClient: HTTP_CLIENT,\n  },\n});\n")),(0,o.kt)("h4",{id:"in-components"},"In components"),(0,o.kt)("p",null,"You can use ",(0,o.kt)("a",{parentName:"p",href:"#useconsumercontext"},"useConsumerContext")," React Hook to get the current context from DI."),(0,o.kt)("h2",{id:"react-hooks"},"React Hooks"),(0,o.kt)("h3",{id:"usestore"},(0,o.kt)("inlineCode",{parentName:"h3"},"useStore()")),(0,o.kt)("p",null,"Hook to get the state of a specific reducer."),(0,o.kt)("p",null,"Features:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"automatically displays the type of state"),(0,o.kt)("li",{parentName:"ul"},"re-renders the component only when the reducer is updated"),(0,o.kt)("li",{parentName:"ul"},'allows you to create reducers "on the fly"')),(0,o.kt)("h4",{id:"interface-4"},"Interface"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"useStore(store: Reducer)")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"store")," - store created by createReducer")),(0,o.kt)("h4",{id:"usage-3"},"Usage"),(0,o.kt)("p",null,"Basic example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"import { useStore } from '@tramvai/state';\nimport { createReducer } from '@tramvai/state';\n\nconst userReducer = createReducer('user', { id: '123' });\n\nexport const Component = () => {\n  const { id } = useStore(userReducer);\n\n  return <div>{id}</div>;\n};\n")),(0,o.kt)("h3",{id:"useselector"},(0,o.kt)("inlineCode",{parentName:"h3"},"useSelector()")),(0,o.kt)("p",null,"Receiving data from the store in components"),(0,o.kt)("h4",{id:"interface-5"},"Interface"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"useSelector(stores: [], selector: (state) => any, equalityFn?: (cur, prev) => boolean)")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"stores")," - a list of tokens that the selector will subscribe to. Will affect which store changes will trigger an update in the component"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"selector")," - the selector itself, this is a function that will be called upon initialization and any changes to the stores passed to ",(0,o.kt)("inlineCode",{parentName:"li"},"stores"),". The function should return data that can be used in the component"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"equalityFn")," - optional function to change the way of comparing past and new values \u200b\u200bof a selector")),(0,o.kt)("h4",{id:"usage-4"},"Usage"),(0,o.kt)("p",null,"To get data from a store, you can use a store name, a reference to a store, or an object with an optional store:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"'storeName'")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"storeObject")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"{ store: storeObject, optional: true }")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"{ store: 'storeName', optional: true }"))),(0,o.kt)("p",null,"You can pass an array of keys, then for correct type inference it is better to use ",(0,o.kt)("inlineCode",{parentName:"p"},"as const"),":"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"useSelector(['fooStoreName', barStoreObject] as const, ({ foo, bar }) => null)"),";")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"import { useSelector } from '@tramvai/state';\n\nexport const Component = () => {\n  const isBrowser = useSelector('media', (state) => state.media.isBrowser);\n\n  return <div>{isBrowser ? <span>Browser</span> : <span>Desktop</span>}</div>;\n};\n")),(0,o.kt)("h4",{id:"optimizations"},"Optimizations"),(0,o.kt)("p",null,"In order to reduce the number of component redrawings, after each call to ",(0,o.kt)("inlineCode",{parentName:"p"},"selector"),", the return values \u200b\u200bare checked against those that were before. If the returned selector data has not changed, then the component will not be redrawn."),(0,o.kt)("p",null,"For this reason, it is better to get small chunks of information in selectors. Then there is less chance that the component will be updated. For example: we need the user's ",(0,o.kt)("inlineCode",{parentName:"p"},"roles"),", we write a selector that requests all user data ",(0,o.kt)("inlineCode",{parentName:"p"},"(state) => state.user")," and now any changes to the ",(0,o.kt)("inlineCode",{parentName:"p"},"user")," reducer will update the component. It is better if we receive only the necessary data ",(0,o.kt)("inlineCode",{parentName:"p"},"(state) => state.user.roles"),", in which case the component will be redrawn only when the user's ",(0,o.kt)("inlineCode",{parentName:"p"},"roles")," change"),(0,o.kt)("h3",{id:"usestoreselector"},(0,o.kt)("inlineCode",{parentName:"h3"},"useStoreSelector()")),(0,o.kt)("p",null,"A simplified version of the useSelector hook into which only one store can be passed, created via createReducer. It was made to improve the inference of selector types, since useSelector itself cannot do this due to the use of strings, tokens and BaseStore heirs inside string names"),(0,o.kt)("h4",{id:"interface-6"},"Interface"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"useStoreSelector(store: Reducer, selector: (state) => any)")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"store")," - Store created through createReducer"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"selector")," - the selector itself, this is a function that will be called upon initialization and any changes to the store passed to ",(0,o.kt)("inlineCode",{parentName:"li"},"stores"),". The function should return data that can be used in the component")),(0,o.kt)("h4",{id:"usage-5"},"Usage"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"import { useStoreSelector } from '@tramvai/state';\nimport { createReducer } from '@tramvai/state';\n\nconst myStore = createReducer('myStore', { id: '123' });\n\nexport const Component = () => {\n  const id = useStoreSelector((myStore, (state) => state.id)); // The id type will be correctly inferred as \"string\"\n\n  return <div>{id}</div>;\n};\n")),(0,o.kt)("h4",{id:"optimizations-1"},"Optimizations"),(0,o.kt)("p",null,"The hook is a wrapper over useSelector, so the optimizations are the same. The selector function itself is memoized inside"),(0,o.kt)("h3",{id:"useactions"},(0,o.kt)("inlineCode",{parentName:"h3"},"useActions()")),(0,o.kt)("p",null,"Allows to execute tramvai ",(0,o.kt)("a",{parentName:"p",href:"/docs/concepts/action"},"actions")," in React components"),(0,o.kt)("h4",{id:"interface-7"},"Interface"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"useActions(actions: Action): Function"),"\n",(0,o.kt)("inlineCode",{parentName:"p"},"useActions(actions: Action[]): Function[]")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"actions")," - one or an array of tramvai actions")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"If you pass an array to ",(0,o.kt)("inlineCode",{parentName:"p"},"useActions"),", for typing you need to specify ",(0,o.kt)("inlineCode",{parentName:"p"},"as const")," - ",(0,o.kt)("inlineCode",{parentName:"p"},"useActions([] as const)"))),(0,o.kt)("h4",{id:"usage-6"},"Usage"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"import { useActions } from '@tramvai/state';\nimport { loadUserAction, getInformationAction, setInformationAction } from './actions';\n\nexport const Component = () => {\n  // if you pass one action, the payload type for loadUser is automatically deduced\n  const loadUser = useActions(loadUserAction);\n\n  // if you pass a list of actions, `as const` is required for correct type inference\n  const [getInformation, setInformation] = useActions([\n    getInformationAction,\n    setInformationAction,\n  ] as const);\n\n  return (\n    <div>\n      <div onClick={loadUser}>load user</div>\n      <div onClick={getInformation}>get information</div>\n      <div onClick={() => setInformation({ user: 1 })}>set information</div>\n    </div>\n  );\n};\n")),(0,o.kt)("h3",{id:"useconsumercontext"},(0,o.kt)("inlineCode",{parentName:"h3"},"useConsumerContext()")),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"Prefer ",(0,o.kt)("a",{parentName:"p",href:"#useactions"},"useActions")," hook if you need to execute actions only")),(0,o.kt)("h4",{id:"interface-8"},"Interface"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"useConsumerContext(): ConsumerContext")," - will return ",(0,o.kt)("a",{parentName:"p",href:"#context"},"ConsumerContext")),(0,o.kt)("h4",{id:"usage-7"},"Usage"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx"},"import { useConsumerContext } from '@tramvai/state';\n\nexport const Component = () => {\n  const context = useConsumerContext();\n\n  useEffect(() => {\n    context.executeAction(anyTramvaiAction, payloadForThisAction);\n  }, []);\n\n  return null;\n};\n")),(0,o.kt)("h3",{id:"connect"},(0,o.kt)("inlineCode",{parentName:"h3"},"connect")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"connect")," is deprecated for couple of reasons:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"connect")," forces you to use decorators, which will have to be significantly changed in the future"),(0,o.kt)("li",{parentName:"ul"},"increases bundle size for 2-3 kb gzip"),(0,o.kt)("li",{parentName:"ul"},"unsafe with React concurrent features at the risk of ",(0,o.kt)("a",{parentName:"li",href:"https://kaihao.dev/posts/Stale-props-and-zombie-children-in-Redux"},"stale props")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#react-hooks"},"React hooks")," are better, faster and safer way to subsribe to the store")),(0,o.kt)("h2",{id:"devtools"},"DevTools"),(0,o.kt)("p",null,"To enable Redux DevTools, you need to run:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Install browser extension: ",(0,o.kt)("a",{parentName:"li",href:"https://chrome.google.com/webstore/detail/redux-devtools/lmhkpmbekcpmknklioeibfkpmmfibljd"},"Chrome extension")," or ",(0,o.kt)("a",{parentName:"li",href:"https://addons.mozilla.org/en-US/firefox/addon/reduxdevtools/"},"FireFox extension")),(0,o.kt)("li",{parentName:"ul"},"Open the page on ",(0,o.kt)("inlineCode",{parentName:"li"},"tramvai")," and open the extension by clicking on the Redux devtools icon")),(0,o.kt)("p",null,(0,o.kt)("img",{parentName:"p",src:"https://cloud.githubusercontent.com/assets/7957859/18002950/aacb82fc-6b93-11e6-9ae9-609862c18302.png",alt:"Redux devtools"})),(0,o.kt)("h3",{id:"possible-problems"},"Possible problems"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"For a better user experience, you need to use a separate redux dev tools extension window, not a tab in chrome developer tools, because otherwise the action history is not saved, see ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/zalmoxisus/redux-devtools-extension/issues/505"},"issue"),".")),(0,o.kt)("h3",{id:"performance"},"Performance"),(0,o.kt)("p",null,"Since the entire state of the application with all the actions is quite large, there are noticeable lags when working with devtools when using jumps over states/events and when a large number of actions are triggered simultaneously. That's why:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Use customization techniques to set pickState to reduce the size of data in devtools."),(0,o.kt)("li",{parentName:"ol"},"Increase the value of the latency parameter (passed to connectViaExtension.connect), which essentially debounces sending actions to the extension, see ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/zalmoxisus/redux-devtools-extension/blob/master/docs/API/Arguments.md#latency"},"docs"))),(0,o.kt)("h3",{id:"additional-links"},"Additional links"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/zalmoxisus/redux-devtools-extension"},"Devtools repository")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://egghead.io/lessons/javascript-getting-started-with-redux-dev-tools"},"Getting Started with Redux DevTools Extension "))),(0,o.kt)("h2",{id:"testing"},"Testing"),(0,o.kt)("p",null,"You can find examples how to test reducers or mock store in our complete ",(0,o.kt)("a",{parentName:"p",href:"/docs/guides/testing"},"Testing Guide"),"!"),(0,o.kt)("h5",{id:"--next-actions"},"- ",(0,o.kt)("a",{parentName:"h5",href:"/docs/features/data-fetching/action"},"Next: Actions")))}m.isMDXComponent=!0}}]);