"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[2150],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>u});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},l=Object.keys(e);for(r=0;r<l.length;r++)n=l[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(r=0;r<l.length;r++)n=l[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=r.createContext({}),p=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},d=function(e){var t=p(e.components);return r.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},g=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,l=e.originalType,s=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),g=p(n),u=o,c=g["".concat(s,".").concat(u)]||g[u]||m[u]||l;return n?r.createElement(c,a(a({ref:t},d),{},{components:n})):r.createElement(c,a({ref:t},d))}));function u(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var l=n.length,a=new Array(l);a[0]=g;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:o,a[1]=i;for(var p=2;p<l;p++)a[p]=n[p];return r.createElement.apply(null,a)}return r.createElement.apply(null,n)}g.displayName="MDXCreateElement"},5919:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>s,default:()=>u,frontMatter:()=>i,metadata:()=>p,toc:()=>m});var r=n(7462),o=n(3366),l=(n(7294),n(3905)),a=["components"],i={},s=void 0,p={unversionedId:"references/modules/log",id:"references/modules/log",title:"log",description:"Module adds LOGGER_TOKEN token implementation using library @tinkoff/logger.",source:"@site/tmp-docs/references/modules/log.md",sourceDirName:"references/modules",slug:"/references/modules/log",permalink:"/docs/references/modules/log",draft:!1,editUrl:"https://github.com/Tinkoff/tramvai/-/edit/master/docs/get-started/overview.md/tmp-docs/references/modules/log.md",tags:[],version:"current",frontMatter:{},sidebar:"sidebar",previous:{title:"http-proxy-agent",permalink:"/docs/references/modules/http-proxy-agent"},next:{title:"metrics",permalink:"/docs/references/modules/metrics"}},d={},m=[{value:"Installation",id:"installation",level:2},{value:"Explanation",id:"explanation",level:2},{value:"Display logs",id:"display-logs",level:3},{value:"See logs from the server in browser",id:"see-logs-from-the-server-in-browser",level:3},{value:"See logs for the requests",id:"see-logs-for-the-requests",level:3},{value:"Change logger settings on server",id:"change-logger-settings-on-server",level:3},{value:"Env",id:"env",level:3},{value:"Debug",id:"debug",level:3},{value:"How to",id:"how-to",level:2},{value:"Example of base usage",id:"example-of-base-usage",level:3},{value:"Send logs to the API",id:"send-logs-to-the-api",level:3},{value:"How to properly format logs",id:"how-to-properly-format-logs",level:3},{value:"Exported tokens",id:"exported-tokens",level:2},{value:"LOGGER_TOKEN",id:"logger_token",level:3}],g={toc:m};function u(e){var t=e.components,n=(0,o.Z)(e,a);return(0,l.kt)("wrapper",(0,r.Z)({},g,n,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("p",null,"Module adds ",(0,l.kt)("inlineCode",{parentName:"p"},"LOGGER_TOKEN")," token implementation using library ",(0,l.kt)("a",{parentName:"p",href:"/docs/references/libs/logger"},"@tinkoff/logger"),"."),(0,l.kt)("h2",{id:"installation"},"Installation"),(0,l.kt)("p",null,"Module is automatically installs and adds with module ",(0,l.kt)("inlineCode",{parentName:"p"},"@tramvai/module-common")),(0,l.kt)("h2",{id:"explanation"},"Explanation"),(0,l.kt)("h3",{id:"display-logs"},"Display logs"),(0,l.kt)("p",null,"see ",(0,l.kt)("a",{parentName:"p",href:"../libs/logger#display-logs"},"@tinkoff/logger"),"."),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"By default, on server all of the logs of level warn and above are enabled. On the client in dev-mode all the logs of level error and above are enabled while in prod-mode all of the logs on client are disabled.")),(0,l.kt)("h3",{id:"see-logs-from-the-server-in-browser"},"See logs from the server in browser"),(0,l.kt)("p",null,"This functionality is available only in dev-mode and can make development a little easier."),(0,l.kt)("p",null,"In browser console when loading page of the app the special log group with name ",(0,l.kt)("inlineCode",{parentName:"p"},"Tramvai SSR Logs")," will be showed. If you open this group you will see logs from the server that was logged to this particular request. Herewith will be displayed only logs that are enabled for the ",(0,l.kt)("a",{parentName:"p",href:"#display-logs"},"displaying on the server"),". If you want to see all of the logs in browser with settings for ",(0,l.kt)("a",{parentName:"p",href:"#display-logs"},"displaying in browser")," you can specify env ",(0,l.kt)("inlineCode",{parentName:"p"},"DEBUG_FULL_SSR")," when running app."),(0,l.kt)("h3",{id:"see-logs-for-the-requests"},"See logs for the requests"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"Works only with ",(0,l.kt)("a",{parentName:"p",href:"https://tinkoff.github.io/tinkoff-request/"},"@tinkoff/request"))),(0,l.kt)("p",null,(0,l.kt)("a",{parentName:"p",href:"/docs/references/modules/http-client"},"http-client")," is already passes logger and its settings to the ",(0,l.kt)("a",{parentName:"p",href:"https://tinkoff.github.io/tinkoff-request/docs/plugins/log.html"},"log plugin"),"."),(0,l.kt)("p",null,"Plugin automatically generates names for loggers using template ",(0,l.kt)("inlineCode",{parentName:"p"},"request.${name}")," that might be used to setting up ",(0,l.kt)("a",{parentName:"p",href:"#display-logs"},"displaying of logs"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-tsx"},"const logger = di.get(LOGGER_TOKEN);\nconst makeRequest = request([...otherPlugins, logger({ name: 'my-api-name', logger })]);\n")),(0,l.kt)("p",null,"As name of the logger equals to ",(0,l.kt)("inlineCode",{parentName:"p"},"my-api-name")," to show logs:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"on server extend env ",(0,l.kt)("inlineCode",{parentName:"li"},"LOG_ENABLE: 'request.my-api-name'")),(0,l.kt)("li",{parentName:"ul"},"on client call ",(0,l.kt)("inlineCode",{parentName:"li"},"logger.enable('request.my-api-name')"))),(0,l.kt)("h3",{id:"change-logger-settings-on-server"},"Change logger settings on server"),(0,l.kt)("p",null,"By default, settings for the logger on server are specified by envs ",(0,l.kt)("inlineCode",{parentName:"p"},"LOG_ENABLE")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"LOG_LEVEL"),"."),(0,l.kt)("p",null,"You can change this settings in runtime using papi-route ",(0,l.kt)("inlineCode",{parentName:"p"},"{app}/private/papi/logger")),(0,l.kt)("p",null,"Displaying of the logs is changed by query with the name ",(0,l.kt)("inlineCode",{parentName:"p"},"enable"),", e.g.:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"https://localhost:3000/{app}/private/papi/logger?enable=request.tinkoff\n")),(0,l.kt)("p",null,"Level of the logs is change by query with the name ",(0,l.kt)("inlineCode",{parentName:"p"},"level"),", e.g.:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"https://localhost:3000/{app}/private/papi/logger?level=warn\n")),(0,l.kt)("p",null,"To reset settings to default, based on env, use ",(0,l.kt)("inlineCode",{parentName:"p"},"mode=default"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre"},"https://localhost:3000/{app}/private/papi/logger?mode=default\n")),(0,l.kt)("h3",{id:"env"},"Env"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"LOG_LEVEL")," = trace | debug | info | warn | error | fatal - show logs with specified level and higher. E.g.:",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"if ",(0,l.kt)("inlineCode",{parentName:"li"},"LOG_LEVEL=info")," then logs with levels ",(0,l.kt)("inlineCode",{parentName:"li"},"info"),", ",(0,l.kt)("inlineCode",{parentName:"li"},"warn"),", ",(0,l.kt)("inlineCode",{parentName:"li"},"error"),", ",(0,l.kt)("inlineCode",{parentName:"li"},"fatal")," will be showed"))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"LOG_ENABLE")," = ",(0,l.kt)("inlineCode",{parentName:"li"},"${name}")," | ",(0,l.kt)("inlineCode",{parentName:"li"},"${level}:${name}")," - show logs with specified name of the logger or name + level. Several entries are passed with comma as delimiter. E.g.:",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"if ",(0,l.kt)("inlineCode",{parentName:"li"},"LOG_ENABLE=server")," then show logs with the name ",(0,l.kt)("inlineCode",{parentName:"li"},"server")),(0,l.kt)("li",{parentName:"ul"},"if ",(0,l.kt)("inlineCode",{parentName:"li"},"LOG_ENABLE=trace:server*")," then show logs with the name ",(0,l.kt)("inlineCode",{parentName:"li"},"server")," and level ",(0,l.kt)("inlineCode",{parentName:"li"},"trace")),(0,l.kt)("li",{parentName:"ul"},"if ",(0,l.kt)("inlineCode",{parentName:"li"},"LOG_ENABLE=info:server,client,trace:shared")," then show all of the specified logs using rules from above")))),(0,l.kt)("h3",{id:"debug"},"Debug"),(0,l.kt)("p",null,"Module uses logger with the id ",(0,l.kt)("inlineCode",{parentName:"p"},"ssr-logger")),(0,l.kt)("h2",{id:"how-to"},"How to"),(0,l.kt)("h3",{id:"example-of-base-usage"},"Example of base usage"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-tsx"},"import { Module, commandLineListToken, provide } from '@tramvai/core';\nimport { LOGGER_TOKEN } from '@tramvai/module-common';\n\n@Module({\n  providers: [\n    provide({\n      provide: commandLineListToken.customerStart,\n      useFactory: ({ logger }) => {\n        logger.debug('customer start'); // logging in the global namespace\n\n        const myLogger = logger({\n          name: 'test',\n        });\n\n        myLogger.warn('warning'); // logging in the namespace test\n        myLogger.error('error!');\n      },\n      deps: {\n        logger: LOGGER_TOKEN,\n      },\n    }),\n  ],\n})\nexport class MyModule {}\n")),(0,l.kt)("h3",{id:"send-logs-to-the-api"},"Send logs to the API"),(0,l.kt)("admonition",{type:"info"},(0,l.kt)("p",{parentName:"admonition"},"It is implied that logs from the server are collected by the external tool that has access to the server console output and because of this logging to the external API from the server is not needed.")),(0,l.kt)("p",null,"For browser logs, you can send them to the API with ",(0,l.kt)("a",{parentName:"p",href:"/docs/references/libs/logger#remotereporter"},"RemoteReporter"),"."),(0,l.kt)("p",null,"For example, if we want to send logs with levels ",(0,l.kt)("inlineCode",{parentName:"p"},"error")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"fatal")," to url declared in environment variable ",(0,l.kt)("inlineCode",{parentName:"p"},"FRONT_LOG_API"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"import { createToken, provide, Scope, APP_INFO_TOKEN } from '@tramvai/core';\nimport { ENV_USED_TOKEN, ENV_MANAGER_TOKEN, LOGGER_INIT_HOOK } from '@tramvai/tokens-common';\nimport { RemoteReporter } from '@tinkoff/logger';\nimport { isUrl } from '@tinkoff/env-validators';\n\nconst REMOTE_REPORTER = createToken<RemoteReporter>('remoteReporter');\n\nconst providers = [\n  // provide new env variable with logs collector endpoint\n  provide({\n    provide: ENV_USED_TOKEN,\n    useValue: [\n      // use isUrl for validation\n      { key: 'FRONT_LOG_API', dehydrate: true, validator: isUrl },\n    ],\n  }),\n  // provide new remote reporter\n  provide({\n    provide: REMOTE_REPORTER,\n    // we need only one instance of reporter\n    scope: Scope.SINGLETON,\n    useFactory: ({ appInfo, envManager, wuid }) => {\n      const { appName } = appInfo;\n      const logApi = envManager.get('FRONT_LOG_API');\n\n      return new RemoteReporter({\n        // number of parallel request\n        requestCount: 1,\n        // log levels which will be send to api\n        emitLevels: { error: true, fatal: true },\n        makeRequest(logObj) {\n          return sendLog({\n            logApi,\n            // additional information for every reported logs\n            payload: {\n              ...logObj,\n              appName,\n              userAgent: window.navigator.userAgent,\n              href: window.location.href,\n            },\n          });\n        },\n      });\n    },\n    deps: {\n      appInfo: APP_INFO_TOKEN,\n      envManager: ENV_MANAGER_TOKEN,\n    },\n  }),\n  // add reporter to logger\n  provide({\n    provide: LOGGER_INIT_HOOK,\n    multi: true,\n    useFactory({ remoteReporter }) {\n      return (loggerInstance) => {\n        loggerInstance.addBeforeReporter(remoteReporter);\n      };\n    },\n    deps: {\n      remoteReporter: REMOTE_REPORTER,\n    },\n  }),\n];\n")),(0,l.kt)("h3",{id:"how-to-properly-format-logs"},"How to properly format logs"),(0,l.kt)("p",null,"See ",(0,l.kt)("a",{parentName:"p",href:"/docs/references/libs/logger#how-to-log-properly"},"@tinkoff/logger")),(0,l.kt)("h2",{id:"exported-tokens"},"Exported tokens"),(0,l.kt)("h3",{id:"logger_token"},"LOGGER_TOKEN"),(0,l.kt)("p",null,"Instance of the logger. Replaces base implementation for the ",(0,l.kt)("inlineCode",{parentName:"p"},"LOGGER_TOKEN")," from the ",(0,l.kt)("a",{parentName:"p",href:"/docs/references/modules/common"},"@tramvai/module-common")))}u.isMDXComponent=!0}}]);