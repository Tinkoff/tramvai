"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[2828],{3905:(e,t,n)=>{n.d(t,{Zo:()=>s,kt:()=>h});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var p=a.createContext({}),c=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},s=function(e){var t=c(e.components);return a.createElement(p.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,p=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),u=c(n),h=i,m=u["".concat(p,".").concat(h)]||u[h]||d[h]||o;return n?a.createElement(m,r(r({ref:t},s),{},{components:n})):a.createElement(m,r({ref:t},s))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=u;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l.mdxType="string"==typeof e?e:i,r[1]=l;for(var c=2;c<o;c++)r[c]=n[c];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},2896:(e,t,n)=>{n.r(t),n.d(t,{frontMatter:()=>l,contentTitle:()=>p,metadata:()=>c,toc:()=>s,default:()=>u});var a=n(7462),i=n(3366),o=(n(7294),n(3905)),r=["components"],l={id:"deploy",title:"Deployment",sidebar_position:4},p=void 0,c={unversionedId:"guides/deploy",id:"guides/deploy",title:"Deployment",description:"Introduction",source:"@site/tmp-docs/guides/deploy.md",sourceDirName:"guides",slug:"/guides/deploy",permalink:"/docs/guides/deploy",editUrl:"https://github.com/Tinkoff/tramvai/-/edit/master/docs/get-started/overview.md/tmp-docs/guides/deploy.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{id:"deploy",title:"Deployment",sidebar_position:4},sidebar:"sidebar",previous:{title:"Separating code for server and client",permalink:"/docs/guides/universal"},next:{title:"Error Boundaries",permalink:"/docs/guides/error-boundary"}},s=[{value:"Introduction",id:"introduction",children:[],level:2},{value:"List of actions required to deploy the application",id:"list-of-actions-required-to-deploy-the-application",children:[{value:"Build the project",id:"build-the-project",children:[],level:3},{value:"Create a docker container",id:"create-a-docker-container",children:[],level:3},{value:"Deploy static assets",id:"deploy-static-assets",children:[],level:3},{value:"Deploy application",id:"deploy-application",children:[],level:3}],level:2},{value:"Explanation",id:"explanation",children:[{value:"Probes",id:"probes",children:[],level:3},{value:"Launching an application without a client CDN",id:"launching-an-application-without-a-client-cdn",children:[],level:3},{value:"Run locally in a docker container",id:"run-locally-in-a-docker-container",children:[{value:"We build the project in production mode, we will have an artifact in the dist directory",id:"we-build-the-project-in-production-mode-we-will-have-an-artifact-in-the-dist-directory",children:[],level:4},{value:"Build a docker application image",id:"build-a-docker-application-image",children:[],level:4},{value:"Run the created image",id:"run-the-created-image",children:[],level:4},{value:"To stop all containers",id:"to-stop-all-containers",children:[],level:4}],level:3}],level:2}],d={toc:s};function u(e){var t=e.components,n=(0,i.Z)(e,r);return(0,o.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"introduction"},"Introduction"),(0,o.kt)("p",null,"Tramvai is a regular node.js application that can be run using standard tools available in the node.js community. Restrictions are only imposed on the file structure and the need to pass ENV variables to the application"),(0,o.kt)("h2",{id:"list-of-actions-required-to-deploy-the-application"},"List of actions required to deploy the application"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"build the application in production mode"),(0,o.kt)("li",{parentName:"ul"},"fill in assets"),(0,o.kt)("li",{parentName:"ul"},"build a docker container with application files"),(0,o.kt)("li",{parentName:"ul"},"run by passing ENV variables")),(0,o.kt)("h3",{id:"build-the-project"},"Build the project"),(0,o.kt)("p",null,"To build the project, you must use the command (before installing the dependencies in the project)"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"tramvai build APP_ID\n")),(0,o.kt)("p",null,"in APP_ID, you must pass the application identifier. After executing the command, the ",(0,o.kt)("inlineCode",{parentName:"p"},"dist")," directory will appear with the build files for the server and client code"),(0,o.kt)("h3",{id:"create-a-docker-container"},"Create a docker container"),(0,o.kt)("p",null,"Recommended Dockerfile"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-dockerfile"},'FROM node:14-buster-slim\nWORKDIR /app\nCOPY dist/server /app/\nCOPY package.json /app/\nENV NODE_ENV=\'production\'\n\nEXPOSE 3000\nCMD [ "node", "--max-http-header-size=80000", "/app/server.js" ]\n')),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"FROM")," - you can put a 14+ version of the node, preferably an alpine version to reduce the size")),(0,o.kt)("h3",{id:"deploy-static-assets"},"Deploy static assets"),(0,o.kt)("p",null,"The recommended way is to upload files to a CDN, since node.js does not do a very good job of serving static content, so there will be a lot of traffic for our infrastructure. Therefore, for production applications that clients will use, you should always use a CDN."),(0,o.kt)("p",null,"To do this, upload the contents of the ",(0,o.kt)("inlineCode",{parentName:"p"},"dist/client")," folder to the CDN according to the method you choose, you get the URL at which the files will be available and substitute this url into the ENV variable ",(0,o.kt)("inlineCode",{parentName:"p"},"ASSETS_PREFIX")," for example ",(0,o.kt)("inlineCode",{parentName:"p"},"ASSETS_PREFIX=https://cdn-domain.com/my-awesome-app/")),(0,o.kt)("p",null,'If you do not need a CDN, then you can see below in the paragraph "Launching an application without a client CDN", it is worth using for test benches or not loaded applications'),(0,o.kt)("h3",{id:"deploy-application"},"Deploy application"),(0,o.kt)("p",null,"The application is launched as a normal node.js process with the node command; when starting, it is necessary to pass all the necessary ENV variables (the list of ENVs depends on the modules used by the application). If you do not add ENV variables, the application will not start. Don't forget about the variable ",(0,o.kt)("inlineCode",{parentName:"p"},"ASSETS_PREFIX")),(0,o.kt)("h2",{id:"explanation"},"Explanation"),(0,o.kt)("h3",{id:"probes"},"Probes"),(0,o.kt)("p",null,"If you deploy to kubernetes, then for these cases there are special urls for probes that you need to use"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"/healthz")," - after starting the application, it always response OK"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"/readyz")," - after starting the application, it always response OK")),(0,o.kt)("h3",{id:"launching-an-application-without-a-client-cdn"},"Launching an application without a client CDN"),(0,o.kt)("p",null,"Tramvai has a built-in static return server. It is better not to do this, for the reason that nodeJS is not the best tool for this and static will affect the application."),(0,o.kt)("p",null,"In general, everything is the same as in a regular deployment, but you need to add copying user assets to the docker image, for this:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"add copy files ",(0,o.kt)("inlineCode",{parentName:"li"},"COPY dist/client /app/public/statics")),(0,o.kt)("li",{parentName:"ul"},"change ENV variable ASSETS_PREFIX")),(0,o.kt)("p",null,"Dockerfile example"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-dockerfile"},'FROM node:14-buster-slim\nWORKDIR /app\nCOPY dist/server /app/\nCOPY package.json /app/\nCOPY dist/client /app/public/statics\nENV NODE_ENV=\'production\'\n\nEXPOSE 3000\nCMD [ "node", "--max-http-header-size=80000", "/app/server.js" ]\n')),(0,o.kt)("p",null,"When starting the application, you must pass ",(0,o.kt)("inlineCode",{parentName:"p"},"ASSETS_PREFIX=/statics/"),". When the application starts, the server for serving statistics will rise and all files inside the /public/ directory will be available. Thus, the client will be able to receive data on the url /statics/payment.js"),(0,o.kt)("h3",{id:"run-locally-in-a-docker-container"},"Run locally in a docker container"),(0,o.kt)("p",null,"The device must have ",(0,o.kt)("a",{parentName:"p",href:"https://www.docker.com/products/docker-desktop"},"https://www.docker.com/products/docker-desktop")," installed and run the command ",(0,o.kt)("inlineCode",{parentName:"p"},"docker run hello-world")),(0,o.kt)("h4",{id:"we-build-the-project-in-production-mode-we-will-have-an-artifact-in-the-dist-directory"},"We build the project in production mode, we will have an artifact in the dist directory"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"yarn build\n")),(0,o.kt)("h4",{id:"build-a-docker-application-image"},"Build a docker application image"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"docker build -t test/myapp .\n")),(0,o.kt)("h4",{id:"run-the-created-image"},"Run the created image"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"docker run --rm -e DANGEROUS_UNSAFE_ENV_FILES='true' -e ASSETS_PREFIX='http://localhost:4000/static/' -v ${PWD}/env.development.js:/app/env.development.js -v ${PWD}/dist/client:/app/static  -e DEV_STATIC=true -p 3000:3000 -p 4000:4000 -d test/myapp\n")),(0,o.kt)("p",null,"To stop the container, you need to get the CONTAINER ID, run the docker ps command and then run the command docker stop <CONTAINER ID",">"),(0,o.kt)("h4",{id:"to-stop-all-containers"},"To stop all containers"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"docker kill $(docker ps --quiet)\n")))}u.isMDXComponent=!0}}]);