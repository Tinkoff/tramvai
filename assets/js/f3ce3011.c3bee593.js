"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[259],{3905:(e,n,t)=>{t.d(n,{Zo:()=>d,kt:()=>m});var a=t(7294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,i=function(e,n){if(null==e)return{};var t,a,i={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var s=a.createContext({}),p=function(e){var n=a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},d=function(e){var n=p(e.components);return a.createElement(s.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},c=a.forwardRef((function(e,n){var t=e.components,i=e.mdxType,l=e.originalType,s=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),c=p(t),m=i,k=c["".concat(s,".").concat(m)]||c[m]||u[m]||l;return t?a.createElement(k,r(r({ref:n},d),{},{components:t})):a.createElement(k,r({ref:n},d))}));function m(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var l=t.length,r=new Array(l);r[0]=c;var o={};for(var s in n)hasOwnProperty.call(n,s)&&(o[s]=n[s]);o.originalType=e,o.mdxType="string"==typeof e?e:i,r[1]=o;for(var p=2;p<l;p++)r[p]=t[p];return a.createElement.apply(null,r)}return a.createElement.apply(null,t)}c.displayName="MDXCreateElement"},4961:(e,n,t)=>{t.r(n),t.d(n,{frontMatter:()=>o,contentTitle:()=>s,metadata:()=>p,toc:()=>d,default:()=>c});var a=t(3117),i=t(102),l=(t(7294),t(3905)),r=["components"],o={id:"build",title:"@tramvai/build"},s=void 0,p={unversionedId:"references/tools/build",id:"references/tools/build",title:"@tramvai/build",description:"Library for building production ready bundles for packages written in TypeScript targetting next environments:",source:"@site/tmp-docs/references/tools/build.md",sourceDirName:"references/tools",slug:"/references/tools/build",permalink:"/docs/references/tools/build",editUrl:"https://github.com/Tinkoff/tramvai/-/edit/master/docs/get-started/overview.md/tmp-docs/references/tools/build.md",tags:[],version:"current",frontMatter:{id:"build",title:"@tramvai/build"},sidebar:"docs",previous:{title:"@tinkoff-monorepo/pkgs-collector-workspaces",permalink:"/docs/references/tools/monorepo-tools/pkgs-collector-workspaces"},next:{title:"@tramvai/tools-migrate",permalink:"/docs/references/tools/migrate"}},d=[{value:"Installation",id:"installation",children:[],level:2},{value:"Explanation",id:"explanation",children:[{value:"NodeJS bundle in CommonJs format",id:"nodejs-bundle-in-commonjs-format",children:[],level:3},{value:"Bundle for bundlers (Webpack, etc.) in ES modules format",id:"bundle-for-bundlers-webpack-etc-in-es-modules-format",children:[],level:3},{value:"Bundle for browsers",id:"bundle-for-browsers",children:[],level:3},{value:"Copy static assets",id:"copy-static-assets",children:[],level:3},{value:"Build and copy migrations",id:"build-and-copy-migrations",children:[],level:3}],level:2},{value:"CLI",id:"cli",children:[{value:"Single build",id:"single-build",children:[],level:3},{value:"Build in watch mode",id:"build-in-watch-mode",children:[],level:3},{value:"Copy static assets",id:"copy-static-assets-1",children:[],level:3},{value:"Available flags",id:"available-flags",children:[],level:3}],level:2},{value:"JavaScript API",id:"javascript-api",children:[{value:"TramvaiBuild",id:"tramvaibuild",children:[],level:3},{value:"Build",id:"build",children:[],level:3},{value:"Copy static files",id:"copy-static-files",children:[],level:3}],level:2},{value:"How to",id:"how-to",children:[{value:"Build separate bundle for browsers",id:"build-separate-bundle-for-browsers",children:[],level:3},{value:"Replace specific module for browser bundle",id:"replace-specific-module-for-browser-bundle",children:[],level:3},{value:"Build all of the packages in monorepo in watch mode",id:"build-all-of-the-packages-in-monorepo-in-watch-mode",children:[],level:3},{value:"Import module only under some circumstances or put module to separate chunk",id:"import-module-only-under-some-circumstances-or-put-module-to-separate-chunk",children:[],level:3},{value:"Use JSON in package",id:"use-json-in-package",children:[],level:3},{value:"Use assets file in the package (e.g. css, svg)",id:"use-assets-file-in-the-package-eg-css-svg",children:[],level:3},{value:"Use css-modules",id:"use-css-modules",children:[],level:3}],level:2}],u={toc:d};function c(e){var n=e.components,t=(0,i.Z)(e,r);return(0,l.kt)("wrapper",(0,a.Z)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,l.kt)("p",null,"Library for building ",(0,l.kt)("inlineCode",{parentName:"p"},"production")," ready bundles for packages written in TypeScript targetting next environments:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"NodeJS"),(0,l.kt)("li",{parentName:"ul"},"Bundlers (Webpack, etc.)"),(0,l.kt)("li",{parentName:"ul"},"Browsers")),(0,l.kt)("h2",{id:"installation"},"Installation"),(0,l.kt)("p",null,"Install ",(0,l.kt)("inlineCode",{parentName:"p"},"@tramvai/build")," first:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"yarn add @tramvai/build\n")),(0,l.kt)("p",null,"Add necessary fields to ",(0,l.kt)("inlineCode",{parentName:"p"},"package.json"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "main": "lib/index.js",\n  "typings": "src/index.ts"\n}\n')),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},(0,l.kt)("inlineCode",{parentName:"p"},'"main": "lib/index.js"')," based on that field lib calculates entry point for the build and it will be ",(0,l.kt)("inlineCode",{parentName:"p"},'"src/index.ts"')," in this case")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},(0,l.kt)("inlineCode",{parentName:"p"},'"typings": "src/index.ts"')," desirable to specify that field to entry point as it is useful for the monorepo projects and allows to use current package in other packages without build. After build package for publication this filed will be replaced to point to the built typedef file, in this case - ",(0,l.kt)("inlineCode",{parentName:"p"},'"typings": "lib/index.d.ts"'))),(0,l.kt)("p",null,"And to ",(0,l.kt)("inlineCode",{parentName:"p"},"tsconfig.json"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "compilerOptions": {\n    "moduleResolution": "node",\n    "target": "ES5",\n    "module": "CommonJS",\n    "declaration": true,\n    "importHelpers": true,\n    "skipLibCheck": true,\n    "rootDir": "./src",\n    "outDir": "./lib",\n    "declarationDir": "./lib"\n  },\n  "include": ["./src"]\n}\n')),(0,l.kt)("p",null,"Add to ",(0,l.kt)("inlineCode",{parentName:"p"},"dependencies")," library ",(0,l.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/tslib"},"tslib"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"yarn add tslib\n")),(0,l.kt)("p",null,"Build package with command ",(0,l.kt)("inlineCode",{parentName:"p"},"tramvai-build"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"tramvai-build --forPublish\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"with flag ",(0,l.kt)("inlineCode",{parentName:"p"},"--forPublish")," tramvai-build replaces some fields in ",(0,l.kt)("inlineCode",{parentName:"p"},"package.json")," in order to make built package usable in the end apps, for example ",(0,l.kt)("inlineCode",{parentName:"p"},'"typings": "src/index.ts"')," replaces by ",(0,l.kt)("inlineCode",{parentName:"p"},'"typings": "lib/index.d.ts"'))),(0,l.kt)("h2",{id:"explanation"},"Explanation"),(0,l.kt)("p",null,"The main purpose for the lib is the effective ",(0,l.kt)("inlineCode",{parentName:"p"},"production")," build for TypeScript package using ",(0,l.kt)("a",{parentName:"p",href:"https://rollupjs.org/"},"rollup"),", with ",(0,l.kt)("a",{parentName:"p",href:"https://rollupjs.org/guide/en/#rollupwatch"},"watch")," mode support."),(0,l.kt)("p",null,"Such builds, especially for monorepositories with big number of packages, can take a long time and are not very comfortable to work. Thats why, for the ",(0,l.kt)("inlineCode",{parentName:"p"},"development")," environment it is preferred to use ",(0,l.kt)("a",{parentName:"p",href:"https://www.typescriptlang.org/docs/handbook/compiler-options.html"},"tsc")," with ",(0,l.kt)("a",{parentName:"p",href:"https://www.typescriptlang.org/docs/handbook/project-references.html"},"project references")," and ",(0,l.kt)("a",{parentName:"p",href:"https://www.typescriptlang.org/docs/handbook/release-notes/typescript-3-4.html#faster-subsequent-builds-with-the---incremental-flag"},"incremental build"),"."),(0,l.kt)("p",null,"Recommended and automatically generated ",(0,l.kt)("inlineCode",{parentName:"p"},"package.json")," for ",(0,l.kt)("inlineCode",{parentName:"p"},"@tramvai/build")," allows apps to use packages that were built either with ",(0,l.kt)("inlineCode",{parentName:"p"},"tsc"),", or with ",(0,l.kt)("inlineCode",{parentName:"p"},"@tramvai/build")," without any additional steps."),(0,l.kt)("p",null,"All of the built bundles will contain ",(0,l.kt)("inlineCode",{parentName:"p"},"ES2019")," standard code, it is expected that they will be bundled to ",(0,l.kt)("inlineCode",{parentName:"p"},"ES5")," using bundler (Webpack, etc.) with configured transpilation through ",(0,l.kt)("inlineCode",{parentName:"p"},"babel")," for packages inside ",(0,l.kt)("inlineCode",{parentName:"p"},"node_modules"),", written in modern JS."),(0,l.kt)("h3",{id:"nodejs-bundle-in-commonjs-format"},"NodeJS bundle in CommonJs format"),(0,l.kt)("p",null,"NodeJS before 12 version hasn't supported ES modules or supported it only behind special flag. ",(0,l.kt)("inlineCode",{parentName:"p"},"@tramvai/build")," generates bundle in ",(0,l.kt)("inlineCode",{parentName:"p"},"ES2019")," standard in ",(0,l.kt)("inlineCode",{parentName:"p"},"CommonJS")," format automatically. Name of the result bundle is taken from field ",(0,l.kt)("inlineCode",{parentName:"p"},"main")," in ",(0,l.kt)("inlineCode",{parentName:"p"},"package.json"),", e.g. ",(0,l.kt)("inlineCode",{parentName:"p"},"lib/index.js"),"."),(0,l.kt)("p",null,"When bundling package in the app using ",(0,l.kt)("inlineCode",{parentName:"p"},"webpack")," with option ",(0,l.kt)("inlineCode",{parentName:"p"},"target: 'node'")," this ",(0,l.kt)("inlineCode",{parentName:"p"},"CommonJS")," bundle probably will not be used as webpack will prefer to use ",(0,l.kt)("inlineCode",{parentName:"p"},"module")," field while resolving source code."),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"It is expected that bundle from field ",(0,l.kt)("inlineCode",{parentName:"p"},'"main"')," will be resolved only by ",(0,l.kt)("inlineCode",{parentName:"p"},"NodeJS")," itself while bundlers will use bundle from field ",(0,l.kt)("inlineCode",{parentName:"p"},'"module"'))),(0,l.kt)("h3",{id:"bundle-for-bundlers-webpack-etc-in-es-modules-format"},"Bundle for bundlers (Webpack, etc.) in ES modules format"),(0,l.kt)("p",null,"Modern bundlers support ES modules and non-standard field ",(0,l.kt)("inlineCode",{parentName:"p"},'"module"')," in ",(0,l.kt)("inlineCode",{parentName:"p"},"package.json"),". ",(0,l.kt)("inlineCode",{parentName:"p"},"@tramvai/build")," generates bundle in ",(0,l.kt)("inlineCode",{parentName:"p"},"ES2019")," standard in ",(0,l.kt)("inlineCode",{parentName:"p"},"ES modules")," format automatically. Name of the result bundle is calculates from field ",(0,l.kt)("inlineCode",{parentName:"p"},"main")," in ",(0,l.kt)("inlineCode",{parentName:"p"},"package.json")," by adding postfix ",(0,l.kt)("inlineCode",{parentName:"p"},".es")," e.g. ",(0,l.kt)("inlineCode",{parentName:"p"},"lib/index.es.js"),"."),(0,l.kt)("p",null,"If build was called with flag ",(0,l.kt)("inlineCode",{parentName:"p"},"--forPublish")," to ",(0,l.kt)("inlineCode",{parentName:"p"},"package.json")," will be added new field ",(0,l.kt)("inlineCode",{parentName:"p"},'"module": "lib/index.es.js"'),"."),(0,l.kt)("p",null,"When bundling package in the app through ",(0,l.kt)("inlineCode",{parentName:"p"},"webpack")," with option ",(0,l.kt)("inlineCode",{parentName:"p"},"target: 'node'")," bundle from field ",(0,l.kt)("inlineCode",{parentName:"p"},"module")," will have higher priority over bundle from ",(0,l.kt)("inlineCode",{parentName:"p"},"main"),"."),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},(0,l.kt)("inlineCode",{parentName:"p"},"ES2019")," code standard is generated as it is expected that bundle from field ",(0,l.kt)("inlineCode",{parentName:"p"},'"module"')," will be resolved by bundler with configured transpilation through ",(0,l.kt)("inlineCode",{parentName:"p"},"babel")," for packages inside ",(0,l.kt)("inlineCode",{parentName:"p"},"node_modules"),", written in modern JS. Why we still prefer to use ",(0,l.kt)("inlineCode",{parentName:"p"},"ES5")," code over ",(0,l.kt)("inlineCode",{parentName:"p"},"ES2019"),"? Apparently, code in ",(0,l.kt)("inlineCode",{parentName:"p"},"ES5")," is still notably faster on NodeJS server. In the same time output bundle size is not important on server.")),(0,l.kt)("h3",{id:"bundle-for-browsers"},"Bundle for browsers"),(0,l.kt)("p",null,"Modern bundlers support ES modules and non-standard field ",(0,l.kt)("inlineCode",{parentName:"p"},'"browser"')," in ",(0,l.kt)("inlineCode",{parentName:"p"},"package.json"),". When field ",(0,l.kt)("inlineCode",{parentName:"p"},"browser")," in specified in ",(0,l.kt)("inlineCode",{parentName:"p"},"package.json"),", ",(0,l.kt)("inlineCode",{parentName:"p"},"@tramvai/build")," will generate bundle in ",(0,l.kt)("inlineCode",{parentName:"p"},"ES2019")," standard in ",(0,l.kt)("inlineCode",{parentName:"p"},"ES modules")," format."),(0,l.kt)("p",null,"If field ",(0,l.kt)("inlineCode",{parentName:"p"},"browser")," in ",(0,l.kt)("inlineCode",{parentName:"p"},"package.json")," is defined as a string then this string determines entry point to ",(0,l.kt)("inlineCode",{parentName:"p"},"browser")," bundle and its name. E.g. when ",(0,l.kt)("inlineCode",{parentName:"p"},'"browser": "lib/browser.js"')," entry point will be ",(0,l.kt)("inlineCode",{parentName:"p"},"src/browser.ts")," and bundle will have a name ",(0,l.kt)("inlineCode",{parentName:"p"},"lib/browser.js"),"."),(0,l.kt)("p",null,"Otherwise, if field ",(0,l.kt)("inlineCode",{parentName:"p"},"browser")," is defined as an object and build was called with flag ",(0,l.kt)("inlineCode",{parentName:"p"},"--forPublish")," then name is defined by the field ",(0,l.kt)("inlineCode",{parentName:"p"},"main")," in ",(0,l.kt)("inlineCode",{parentName:"p"},"package.json")," with adding postfix ",(0,l.kt)("inlineCode",{parentName:"p"},".browser")," e.g. ",(0,l.kt)("inlineCode",{parentName:"p"},"lib/index.browser.js"),". After that to field ",(0,l.kt)("inlineCode",{parentName:"p"},"browser")," new property will be added as pointer for bundlers to bundle for the browser, instead of the field ",(0,l.kt)("inlineCode",{parentName:"p"},"module"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "browser": {\n    ...,\n    "./index.es.js": "./index.browser.js"\n  }\n}\n')),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"Specification for the field ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/defunctzombie/package-browser-field-spec"},"browser"))),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},(0,l.kt)("inlineCode",{parentName:"p"},"ES2019")," code standard is generated as it is expected that bundle from ",(0,l.kt)("inlineCode",{parentName:"p"},'"browser"')," field will be resolved by bundler with configured transpilation through ",(0,l.kt)("inlineCode",{parentName:"p"},"babel")," for packages inside ",(0,l.kt)("inlineCode",{parentName:"p"},"node_modules")," written in modern JS to the code according to the ",(0,l.kt)("inlineCode",{parentName:"p"},"browserslist")," config.")),(0,l.kt)("p",null,"When building our package in the app with ",(0,l.kt)("inlineCode",{parentName:"p"},"webpack")," with option ",(0,l.kt)("inlineCode",{parentName:"p"},"target: 'web'")," bundle from field ",(0,l.kt)("inlineCode",{parentName:"p"},"browser")," will be prioritized over field ",(0,l.kt)("inlineCode",{parentName:"p"},"module"),"."),(0,l.kt)("h3",{id:"copy-static-assets"},"Copy static assets"),(0,l.kt)("p",null,"For every build, all of the non JS/TS/JSON files (e.g. CSS, fonts, images) are copied to the output bundle preserving their relative paths (e.g. ",(0,l.kt)("inlineCode",{parentName:"p"},"src/css/style.css")," -> ",(0,l.kt)("inlineCode",{parentName:"p"},"lib/css/style.css"),"). You can disable such copying by using flag ",(0,l.kt)("inlineCode",{parentName:"p"},"copyStaticAssets"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"tramvai-build --copyStaticAssets false\n")),(0,l.kt)("h3",{id:"build-and-copy-migrations"},"Build and copy migrations"),(0,l.kt)("p",null,"When directory ",(0,l.kt)("inlineCode",{parentName:"p"},"migrations")," has any code files they are considered as migration files. These files will be compiled to ",(0,l.kt)("inlineCode",{parentName:"p"},".js")," and copied to directory ",(0,l.kt)("inlineCode",{parentName:"p"},"__migrations__"),"."),(0,l.kt)("h2",{id:"cli"},"CLI"),(0,l.kt)("h3",{id:"single-build"},"Single build"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"tramvai-build\n")),(0,l.kt)("h3",{id:"build-in-watch-mode"},"Build in watch mode"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"tramvai-build --watch\n")),(0,l.kt)("h3",{id:"copy-static-assets-1"},"Copy static assets"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"tramvai-copy\n")),(0,l.kt)("h3",{id:"available-flags"},"Available flags"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"tramvai-build --help\n")),(0,l.kt)("h2",{id:"javascript-api"},"JavaScript API"),(0,l.kt)("h3",{id:"tramvaibuild"},"TramvaiBuild"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"TramvaiBuild")," is used to configure build process for following usage."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"import { TramvaiBuild } from '@tramvai/build';\n\nnew TramvaiBuild(options);\n")),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"Available options:")),(0,l.kt)("p",null,(0,l.kt)("pre",{parentName:"p"},(0,l.kt)("code",{parentName:"pre",className:"language-typescript"},"export type Options = {\n  sourceDir?: string;\n  watchMode?: boolean;\n  copyStaticAssets?: boolean;\n  forPublish?: boolean;\n};\n\n"))),(0,l.kt)("h3",{id:"build"},"Build"),(0,l.kt)("p",null,"Method ",(0,l.kt)("inlineCode",{parentName:"p"},"TramvaiBuild.start")," builds package either single time or in ",(0,l.kt)("inlineCode",{parentName:"p"},"watch")," mode depending on configuration of ",(0,l.kt)("inlineCode",{parentName:"p"},"TramvaiBuild"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"import { TramvaiBuild } from '@tramvai/build';\n\nnew TramvaiBuild(options).start();\n")),(0,l.kt)("h3",{id:"copy-static-files"},"Copy static files"),(0,l.kt)("p",null,"Method ",(0,l.kt)("inlineCode",{parentName:"p"},"TramvaiBuild.copy")," copies static assets to the ",(0,l.kt)("inlineCode",{parentName:"p"},"output")," directory:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"import { TramvaiBuild } from '@tramvai/build';\n\nnew TramvaiBuild(options).copy();\n")),(0,l.kt)("h2",{id:"how-to"},"How to"),(0,l.kt)("h3",{id:"build-separate-bundle-for-browsers"},"Build separate bundle for browsers"),(0,l.kt)("p",null,"Let's say we have to entry points. One is for the server - ",(0,l.kt)("inlineCode",{parentName:"p"},"src/server.ts")," and for the client - ",(0,l.kt)("inlineCode",{parentName:"p"},"src/browser.ts"),". In this case we should set field ",(0,l.kt)("inlineCode",{parentName:"p"},"browser")," in ",(0,l.kt)("inlineCode",{parentName:"p"},"package.json")," the next way:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "main": "lib/server.js",\n  "browser": "lib/browser.js"\n}\n')),(0,l.kt)("p",null,"After build for publication we will get next ",(0,l.kt)("inlineCode",{parentName:"p"},"package.json"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "main": "lib/server.js",\n  "browser": "lib/browser.js",\n  "typings": "lib/server.d.ts",\n  "module": "lib/server.es.js"\n}\n')),(0,l.kt)("h3",{id:"replace-specific-module-for-browser-bundle"},"Replace specific module for browser bundle"),(0,l.kt)("p",null,"Let's say we have one entry point - ",(0,l.kt)("inlineCode",{parentName:"p"},"src/index.ts")," and a module ",(0,l.kt)("inlineCode",{parentName:"p"},"src/external.ts")," we want to replace by ",(0,l.kt)("inlineCode",{parentName:"p"},"src/external.browser.ts"),". In this case we should set field ",(0,l.kt)("inlineCode",{parentName:"p"},"browser")," in ",(0,l.kt)("inlineCode",{parentName:"p"},"package.json")," the next way:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "main": "lib/index.js",\n  "browser": {\n    "./lib/external.js": "./lib/external.browser.js"\n  }\n}\n')),(0,l.kt)("p",null,"After build for publication we will get next ",(0,l.kt)("inlineCode",{parentName:"p"},"package.json"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "main": "lib/index.js",\n  "browser": {\n    "./lib/external.js": "./lib/external.browser.js",\n    "./lib/index.es.js": "./lib/index.browser.js"\n  },\n  "typings": "lib/index.d.ts",\n  "module": "lib/index.es.js"\n}\n')),(0,l.kt)("h3",{id:"build-all-of-the-packages-in-monorepo-in-watch-mode"},"Build all of the packages in monorepo in watch mode"),(0,l.kt)("p",null,"@TODO + link to ",(0,l.kt)("inlineCode",{parentName:"p"},"@tinkoff/fix-ts-references")),(0,l.kt)("h3",{id:"import-module-only-under-some-circumstances-or-put-module-to-separate-chunk"},"Import module only under some circumstances or put module to separate chunk"),(0,l.kt)("p",null,"Instead of static imports you can use dynamic import or require. In this case imported module will be build in the separate chunk. Later this chunk can be added by bundler to the generated bundle and if dynamic import was used it will be separate chunk as well after bundlers build, but when using require separate chunk will not be generated."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-tsx"},"let func = noop;\n\nif (process.env.NODE_ENV !== 'production') {\n  func = require('./realFunc').func;\n}\n\nexport { func };\n")),(0,l.kt)("h3",{id:"use-json-in-package"},"Use JSON in package"),(0,l.kt)("p",null,"By default in root ",(0,l.kt)("inlineCode",{parentName:"p"},"tsconfig.json")," option ",(0,l.kt)("inlineCode",{parentName:"p"},"resolveJsonModule")," is enabled. It is allows to import json-files the same way as usual source code using ",(0,l.kt)("inlineCode",{parentName:"p"},"import"),", moreover typecheck and tree-shaking will work to json as well when publishing package. To disable ts errors for json imports add to ",(0,l.kt)("inlineCode",{parentName:"p"},"tsconfig.json")," of the package new entry to field ",(0,l.kt)("inlineCode",{parentName:"p"},"includes"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "includes": ["./src", "./src/**/*.json"]\n}\n')),(0,l.kt)("h3",{id:"use-assets-file-in-the-package-eg-css-svg"},"Use assets file in the package (e.g. css, svg)"),(0,l.kt)("p",null,"These files are not used in bundle or source code and ts will ignore them. For proper package usage additional setup should be done. Add script ",(0,l.kt)("inlineCode",{parentName:"p"},"tramvai-copy")," to ",(0,l.kt)("inlineCode",{parentName:"p"},"package.json"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "scripts": {\n    "copy-static-assets": "tramvai-copy"\n  }\n}\n')),(0,l.kt)("p",null,"This script will copy not related files to source code to the output directory. Copying itself happens either on dependencies install in the repository root or on package publishing. As for some reasons output directory might be deleted it may be needed to rerun ",(0,l.kt)("inlineCode",{parentName:"p"},"tramvai-copy")," command for package."),(0,l.kt)("h3",{id:"use-css-modules"},"Use css-modules"),(0,l.kt)("p",null,"In order to disable typescript errors for css-modules imports add new file ",(0,l.kt)("inlineCode",{parentName:"p"},"typings.d.ts")," to the ",(0,l.kt)("inlineCode",{parentName:"p"},"src")," folder with the next content:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-tsx"},"declare module '*.css' {\n  const value: any;\n  export default value;\n}\n")),(0,l.kt)("p",null,"To copy css while deb-build change next command:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'"watch": "tramvai-copy && tsc -w"\n')),(0,l.kt)("p",null,"Such imports are not compiled. To use it properly you can use ",(0,l.kt)("inlineCode",{parentName:"p"},"@tramvai/cli")," for building app or any other solution for the css-modules."),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"When building correctness of imports for the css is not checking so check your package manually before publication.")))}c.isMDXComponent=!0}}]);